<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadMentor Quiz</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        window.FirebaseApp = { initializeApp };
    </script>
    <script type="module">
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        window.FirebaseAuth = { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged };
    </script>
    <script type="module">
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        window.FirebaseFirestore = { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove };
    </script>

    <!-- Your React Component -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { initializeApp } = window.FirebaseApp;
        const { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = window.FirebaseAuth;
        const { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, arrayRemove } = window.FirebaseFirestore;

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Mock Quiz Questions
        const quizQuestions = [
            { id: 'Q001', text: 'Which imaging modality uses X-rays to create detailed images of bones and soft tissues?', options: ['MRI', 'Ultrasound', 'CT Scan', 'Nuclear Medicine'], correctAnswer: 'CT Scan' },
            { id: 'Q002', text: 'What does MRI stand for?', options: ['Magnetic Resonance Imaging', 'Medical Radiation Instrument', 'Molecular Radiography Index', 'Magnetism Resonance Indicator'], correctAnswer: 'Magnetic Resonance Imaging' },
            { id: 'Q003', text: 'Which imaging technique is best for visualizing a fetus during pregnancy?', options: ['CT Scan', 'X-ray', 'Ultrasound', 'PET Scan'], correctAnswer: 'Ultrasound' },
            { id: 'Q004', text: 'What type of radiation is used in a PET scan?', options: ['Alpha particles', 'Beta particles', 'Gamma rays', 'Positrons'], correctAnswer: 'Positrons' },
        ];

        function App() {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [loading, setLoading] = useState(true);
            const [userProgress, setUserProgress] = useState({ completedQuestions: [], bookmarkedQuestions: [] });
            const [message, setMessage] = useState('');
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [answerFeedback, setAnswerFeedback] = useState(null);

            useEffect(() => {
                const initFirebase = async () => {
                    try {
                        const app = initializeApp(firebaseConfig);
                        const firestoreDb = getFirestore(app);
                        const firebaseAuth = getAuth(app);
                        setDb(firestoreDb);
                        setAuth(firebaseAuth);

                        onAuthStateChanged(firebaseAuth, async (user) => {
                            if (user) {
                                setUserId(user.uid);
                                await loadUserProgress(firestoreDb, user.uid);
                            } else {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(firebaseAuth, initialAuthToken);
                                } else {
                                    await signInAnonymously(firebaseAuth);
                                }
                            }
                            setLoading(false);
                        });
                    } catch (error) {
                        console.error("Error initializing Firebase:", error);
                        setMessage(`Error initializing Firebase: ${error.message}`);
                        setLoading(false);
                    }
                };
                initFirebase();
            }, []);

            const loadUserProgress = async (firestoreDb, currentUserId) => {
                if (!firestoreDb || !currentUserId) return;
                try {
                    const userDocRef = doc(firestoreDb, `artifacts/${appId}/users/${currentUserId}/quizProgress`, 'myProgress');
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setUserProgress({
                            completedQuestions: data.completedQuestions || [],
                            bookmarkedQuestions: data.bookmarkedQuestions || []
                        });
                        setMessage('User progress loaded successfully!');
                    } else {
                        await setDoc(userDocRef, { completedQuestions: [], bookmarkedQuestions: [] });
                        setMessage('New user progress document created.');
                    }
                } catch (error) {
                    console.error("Error loading user progress:", error);
                    setMessage(`Error loading user progress: ${error.message}`);
                }
            };

            const saveCompletedQuestion = async (questionId) => {
                if (!db || !userId) return;
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/quizProgress`, 'myProgress');
                    await updateDoc(userDocRef, { completedQuestions: arrayUnion(questionId) });
                    setUserProgress(prev => ({ ...prev, completedQuestions: [...new Set([...prev.completedQuestions, questionId])] }));
                } catch (error) {
                    console.error("Error saving completed question:", error);
                    setMessage(`Error saving completed question: ${error.message}`);
                }
            };

            const toggleBookmarkQuestion = async (questionId) => {
                if (!db || !userId) return;
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/quizProgress`, 'myProgress');
                    const isBookmarked = userProgress.bookmarkedQuestions.includes(questionId);
                    if (isBookmarked) {
                        await updateDoc(userDocRef, { bookmarkedQuestions: arrayRemove(questionId) });
                        setUserProgress(prev => ({ ...prev, bookmarkedQuestions: prev.bookmarkedQuestions.filter(id => id !== questionId) }));
                        setMessage(`Question ${questionId} unbookmarked.`);
                    } else {
                        await updateDoc(userDocRef, { bookmarkedQuestions: arrayUnion(questionId) });
                        setUserProgress(prev => ({ ...prev, bookmarkedQuestions: [...new Set([...prev.bookmarkedQuestions, questionId])] }));
                        setMessage(`Question ${questionId} bookmarked!`);
                    }
                } catch (error) {
                    console.error("Error toggling bookmark:", error);
                    setMessage(`Error toggling bookmark: ${error.message}`);
                }
            };

            const handleOptionSelect = (option) => {
                setSelectedOption(option);
                setAnswerFeedback(null);
            };

            const handleSubmitAnswer = () => {
                const currentQuestion = quizQuestions[currentQuestionIndex];
                if (selectedOption === currentQuestion.correctAnswer) {
                    setAnswerFeedback('correct');
                    saveCompletedQuestion(currentQuestion.id);
                    setMessage(`Correct! Question ${currentQuestion.id} completed.`);
                } else {
                    setAnswerFeedback('incorrect');
                    setMessage(`Incorrect. Try again or move to the next question.`);
                }
            };

            const handleNextQuestion = () => {
                if (currentQuestionIndex < quizQuestions.length - 1) {
                    setCurrentQuestionIndex(prevIndex => prevIndex + 1);
                    setSelectedOption(null);
                    setAnswerFeedback(null);
                    setMessage('');
                } else {
                    setMessage('You have completed all questions!');
                }
            };

            const handlePreviousQuestion = () => {
                if (currentQuestionIndex > 0) {
                    setCurrentQuestionIndex(prevIndex => prevIndex - 1);
                    setSelectedOption(null);
                    setAnswerFeedback(null);
                    setMessage('');
                } else {
                    setMessage('You are at the first question.');
                }
            };

            const currentQuestion = quizQuestions[currentQuestionIndex];
            const isCurrentQuestionBookmarked = userProgress.bookmarkedQuestions.includes(currentQuestion.id);

            if (loading) {
                return <div className="flex items-center justify-center h-screen bg-gray-100"><div className="text-xl font-semibold text-gray-700">Loading Firebase and authenticating...</div></div>;
            }

            return (
                <div className="min-h-screen bg-gray-100 text-gray-800 font-sans p-4 sm:p-6 lg:p-8">
                    <div className="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                        <h1 className="text-3xl sm:text-4xl font-extrabold text-center mb-2 text-gray-900">Radiology Quiz</h1>
                        <p className="text-center text-gray-500 mb-6">Your unique user ID: <span className="font-mono bg-gray-200 px-2 py-1 rounded">{userId || 'N/A'}</span></p>

                        {message && <div className={`p-4 mb-6 rounded-lg text-center text-white ${answerFeedback === 'correct' ? 'bg-green-500' : answerFeedback === 'incorrect' ? 'bg-red-500' : 'bg-blue-500'}`}>{message}</div>}

                        <div className="border-t border-gray-200 pt-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">Question {currentQuestionIndex + 1} of {quizQuestions.length}</h2>
                            <p className="text-lg text-gray-700 mb-6 min-h-[60px]">{currentQuestion.text}</p>
                            <div className="space-y-3">
                                {currentQuestion.options.map((option, index) => (
                                    <button key={index} onClick={() => handleOptionSelect(option)} disabled={answerFeedback !== null} className={`w-full text-left p-4 rounded-lg border-2 transition-all duration-200 ease-in-out ${selectedOption === option ? 'bg-blue-100 border-blue-500' : 'bg-white hover:bg-gray-50 border-gray-300'} ${answerFeedback !== null ? 'cursor-not-allowed' : 'cursor-pointer'} ${answerFeedback === 'correct' && option === currentQuestion.correctAnswer ? '!bg-green-100 !border-green-500' : ''} ${answerFeedback === 'incorrect' && option === selectedOption ? '!bg-red-100 !border-red-500' : ''}`}>
                                        {option}
                                    </button>
                                ))}
                            </div>

                            <div className="mt-6 flex flex-col sm:flex-row sm:justify-between gap-4">
                                <button onClick={handleSubmitAnswer} disabled={!selectedOption || answerFeedback !== null} className="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 disabled:transform-none">Submit Answer</button>
                                <button onClick={() => toggleBookmarkQuestion(currentQuestion.id)} className={`w-full sm:w-auto font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 ${isCurrentQuestionBookmarked ? 'bg-yellow-500 hover:bg-yellow-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`}>{isCurrentQuestionBookmarked ? 'Bookmarked!' : 'Toggle Bookmark'}</button>
                            </div>

                            <div className="mt-6 flex justify-between">
                                <button onClick={handlePreviousQuestion} disabled={currentQuestionIndex === 0} className="bg-gray-500 hover:bg-gray-600 disabled:bg-gray-300 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out">Previous</button>
                                <button onClick={handleNextQuestion} disabled={currentQuestionIndex === quizQuestions.length - 1} className="bg-gray-500 hover:bg-gray-600 disabled:bg-gray-300 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out">Next</button>
                            </div>
                        </div>

                        <div className="mt-8 pt-6 border-t border-gray-200">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 className="text-xl font-bold mb-3 text-gray-800">Completed Questions</h3>
                                    <div className="bg-gray-50 p-4 rounded-lg max-h-48 overflow-y-auto">
                                        {userProgress.completedQuestions.length > 0 ? <ul className="list-disc list-inside space-y-1 text-gray-600">{userProgress.completedQuestions.map(qId => <li key={qId}>{qId}</li>)}</ul> : <p className="text-gray-500">No questions completed yet.</p>}
                                    </div>
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold mb-3 text-gray-800">Bookmarked Questions</h3>
                                    <div className="bg-gray-50 p-4 rounded-lg max-h-48 overflow-y-auto">
                                        {userProgress.bookmarkedQuestions.length > 0 ? <ul className="list-disc list-inside space-y-1 text-gray-600">{userProgress.bookmarkedQuestions.map(qId => <li key={qId}>{qId}</li>)}</ul> : <p className="text-gray-500">No questions bookmarked yet.</p>}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <footer className="mt-8 text-center text-sm text-gray-500">
                            <p>This app automatically handles authentication. Your progress is saved using the User ID shown above.</p>
                        </footer>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
