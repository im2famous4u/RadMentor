<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fellowship Exams Quiz - RadScribe AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: "Inter", sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .glass-card { background-color: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-radius: 1.5rem; padding: 2rem; box-shadow: 0 10px 20px rgba(0,0,0,0.05), 0 6px 6px rgba(0,0,0,0.03); max-width: 800px; width: 100%; display: flex; flex-direction: column; gap: 1.5rem; }
        .quiz-container { max-width: 800px; margin: 0 auto; background: transparent; border-radius: 15px; box-shadow: none; overflow: hidden; animation: fadeIn 0.5s; touch-action: pan-y; display: flex; flex-direction: column; }
        @keyframes fadeIn {from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        @keyframes slideIn {from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1)}}
        .quiz-header { position: sticky; top: 0; z-index: 1000; background: white; padding: 20px; border-bottom: 1px solid rgba(0,0,0,0.08); position: relative; border-radius: 1.5rem 1.5rem 0 0; }
        .question-card { border:none; box-shadow:0 5px 20px rgba(0,0,0,0.06); margin-bottom:25px; border-radius:15px; overflow:hidden; transition:all 0.4s ease; animation:slideIn 0.4s; background-color: #ffffff; }
        .option-btn { text-align:left; padding:16px 20px; margin-bottom:12px; border-radius:12px; transition:all 0.3s ease; position:relative; overflow:hidden; border:1px solid #e2e8f0; background-color: #f8fafc; color: #333; }
        .option-btn:hover {background-color:#e2e8f0;transform:translateX(5px);box-shadow:0 3px 10px rgba(0,0,0,0.05)}
        .option-btn.selected {background-color:#fce7f3;border-color:#f472b6;font-weight:500;box-shadow:0 5px 15px rgba(236,72,153,0.15); color: #333;}
        .option-btn.correct {background-color:#dcfce7;border-color:#4ade80; color: #166534;}
        .option-btn.incorrect {background-color:#fee2e2;border-color:#f87171; color: #b91c1c;}
        .quiz-pagination { display:flex;justify-content:center;flex-wrap:wrap;gap:10px;margin:15px 0;padding:10px 0; }
        .quiz-pagination .page-box { width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:600;background-color:#f8fafc;color:#555;border:1px solid #e2e8f0;cursor:pointer;transition:all 0.3s ease; border-radius: 0.5rem; position: relative;}
        .quiz-pagination .page-box.active {background-color:#ec4899;border-color:#ec4899;color:white}
        .quiz-pagination .page-box.correct {background-color:#28a745;border-color:#28a745;color:white}
        .quiz-pagination .page-box.incorrect {background-color:#dc3545;border-color:#dc3545;color:white}
        .quiz-pagination .page-box.marked-for-review::after { content: 'ðŸš©'; position: absolute; top: -8px; right: -5px; font-size: 12px; }
        .explanation { background-color:#f8fafc;padding:15px;border-radius:8px;margin-top:15px;border-left:3px solid #ec4899; color: #333; }
        .result-card { display:none;animation:fadeIn 0.5s; background-color: #ffffff; border-radius: 1.5rem; padding: 2rem; }
        .score-highlight { font-size:48px;font-weight:700;color:#ec4899;text-align:center;margin:20px 0 }
        .chart-container { height:220px }
        .confetti {position:fixed;width:10px;height:10px;background-color:#f00;position:absolute;top:0;z-index:9999}
        .question-image, .explanation-image { max-width: 100%; height: auto; border-radius: 8px; margin-top: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        #paperSelectionContainer { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 400px; padding: 20px; text-align: center; }
        .quiz-controls { position: absolute; top: 15px; right: 20px; display: flex; gap: 10px; z-index: 1001; align-items: center; }
        .icon-btn { font-size: 1.5rem; cursor: pointer; color: #d1d5db; transition: color 0.2s ease-in-out, transform 0.2s ease; background: none; border: none; padding: 0 5px; }
        .icon-btn:hover { transform: scale(1.1); }
        .bookmark-btn.bookmarked { color: #f59e0b; }
        .flag-btn.flagged { color: #ef4444; }
        .paper-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
        .paper-card { background-color: #ffffff; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; transition: all 0.2s ease-in-out; border: 1px solid #e2e8f0; }
        .paper-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); border-color: #ec4899; }
        .paper-card-icon { width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; border-radius: 50%; margin-bottom: 1rem; font-size: 2rem; font-weight: 700; }
        .paper-card-icon.bg-blue-100 { background-color: #e0f2fe; color: #3b82f6; }
        .paper-card-icon.bg-pink-100 { background-color: #fdf2f8; color: #ec4899; }
        #authCheckScreen { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f0f2f5; z-index: 9999; }
    </style>
</head>
<body>
    <audio id="clickSound" src="https://assets.mixkit.co/active_storage/sfx/269/269.wav" preload="auto"></audio>
    <audio id="swipeSound" src="https://assets.mixkit.co/active_storage/sfx/1897/1897.wav" preload="auto"></audio>
    <audio id="correctSound" src="https://assets.mixkit.co/active_storage/sfx/2870/2870.wav" preload="auto"></audio>
    <audio id="wrongSound" src="https://assets.mixkit.co/active_storage/sfx/2964/2964.wav" preload="auto"></audio>

    <div id="authCheckScreen">
        <div class="text-center p-5 bg-white rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold mb-4">Verifying Access...</h1>
            <p class="text-gray-600">Please wait while we check your login status.</p>
            <div class="spinner-border text-pink-500 mt-4" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>
    </div>

    <div class="container my-4">
        <div class="quiz-container glass-card" id="quizContainer" style="display: none;">
            <h1 class="text-3xl font-extrabold text-gray-900 text-center mb-6">Fellowship Exam Quiz</h1>

            <div id="paperSelectionContainer">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Select a Paper to Begin</h2>
                <div id="paper-card-grid" class="paper-card-grid"></div>
                <div class="d-flex justify-content-center mt-5">
                    <a href="../dashboard/bookmark.html" class="btn btn-info btn-lg px-5 py-2 rounded-pill shadow">
                        <i class="fas fa-bookmark me-2"></i>My Bookmarks
                    </a>
                </div>
            </div>

            <div id="mainQuizContent" style="display: none;">
                <div class="quiz-header shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="m-0 fw-bold">Paper <span id="currentPaperDisplay"></span></h2>
                        <div class="quiz-controls">
                             <button id="homeBtn" class="btn btn-secondary btn-sm"><i class="fas fa-home me-1"></i> Home</button>
                        </div>
                    </div>
                    <div class="progress mt-3">
                        <div id="practiceProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width:0%"></div>
                    </div>
                </div>
                <div class="p-4">
                    <div id="questionContainer"></div>
                    <div class="quiz-pagination" id="questionNav"></div>
                </div>
            </div>

            <div id="resultContainer" class="result-card p-4" style="display: none;">
                <h3 class="text-center fw-bold mb-4">Quiz Results</h3>
                <div class="score-highlight" id="scoreDisplay"></div>
                 <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card shadow-sm h-100"><div class="card-body"><h5 class="card-title fw-bold">Score Summary</h5>
                            <div class="d-flex justify-content-between mb-2"><span>Total Questions:</span><span id="totalQuestions" class="fw-bold"></span></div>
                            <div class="d-flex justify-content-between mb-2"><span>Correct Answers:</span><span id="correctAnswers" class="fw-bold text-success">0</span></div>
                            <div class="d-flex justify-content-between mb-2"><span>Incorrect Answers:</span><span id="incorrectAnswers" class="fw-bold text-danger">0</span></div>
                            <div class="d-flex justify-content-between"><span>Unattempted:</span><span id="unattempted" class="fw-bold text-warning">0</span></div>
                        </div></div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm h-100"><div class="card-body"><h5 class="card-title fw-bold">Performance</h5><div class="chart-container"><canvas id="performanceChart"></canvas></div></div></div>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <div class="btn-group" role="group" aria-label="Review Options">
                        <button id="reviewAllBtn" class="btn btn-primary rounded-pill px-4">Review All</button>
                        <button id="reviewIncorrectBtn" class="btn btn-danger rounded-pill px-4 ms-2">Review Incorrect</button>
                        <button id="reviewBookmarkedBtn" class="btn btn-warning rounded-pill px-4 ms-2">Review Bookmarked</button>
                    </div>
                    <button id="restartQuizBtn" class="btn btn-secondary rounded-pill px-4 ms-3"><i class="fas fa-redo me-2"></i>Restart</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="resumePromptModal" tabindex="-1" aria-labelledby="resumePromptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resumePromptModalLabel">Resume Quiz?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    We found saved progress for this paper. Would you like to resume where you left off?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="startNewBtn">Start New</button>
                    <button type="button" class="btn btn-primary" id="resumeBtn">Yes, Resume</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        // --- CORRECT WAY: Import the SHARED services from your central file ---
        import { auth, db } from '../js/firebase.js'; // Assumes this file is in a 'fellowshipexams' folder
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { collection, doc, setDoc, deleteDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        
        // --- Data Configuration ---
        const allQuizData = {
            paper1: { sheetId: "13bIVTjrFwqcP0Q7WitSvb3ksy7g9XWXrq4uLOQwzLmo", gid: "0" },
            paper2: { sheetId: "13bIVTjrFwqcP0Q7WitSvb3ksy7g9XWXrq4uLOQwzLmo", gid: "1141721868" },
        };
        const paperMetadata = [
            { id: 'paper1', name: 'Paper 1', displayNumber: 1, bgColor: 'bg-blue-100' },
            { id: 'paper2', name: 'Paper 2', displayNumber: 2, bgColor: 'bg-pink-100' },
        ];
        
        // --- Global State & Elements ---
        let currentQuizData = [], currentPaperId = '', currentUser = null, userBookmarks = new Set(), reviewFilter = [];
        const state = {
            currentQuestion: 0, answers: [], submitted: false, timePerQuestion: [], markedForReview: []
        };
        const sounds = {
            click: document.getElementById('clickSound'),
            correct: document.getElementById('correctSound'),
            wrong: document.getElementById('wrongSound')
        };
        const dom = {
            authCheckScreen: document.getElementById('authCheckScreen'),
            quizContainer: document.getElementById('quizContainer'),
            paperSelection: document.getElementById('paperSelectionContainer'),
            mainQuizContent: document.getElementById('mainQuizContent'),
            resultContainer: document.getElementById('resultContainer'),
            questionContainer: document.getElementById('questionContainer'),
            questionNav: document.getElementById('questionNav'),
            homeBtn: document.getElementById('homeBtn'),
            restartQuizBtn: document.getElementById('restartQuizBtn'),
            reviewAllBtn: document.getElementById('reviewAllBtn'),
            reviewIncorrectBtn: document.getElementById('reviewIncorrectBtn'),
            reviewBookmarkedBtn: document.getElementById('reviewBookmarkedBtn'),
            paperCardGrid: document.getElementById('paper-card-grid'),
            currentPaperDisplay: document.getElementById('currentPaperDisplay'),
            practiceProgress: document.getElementById('practiceProgress')
        };
        
        // --- App Initialization & Auth ---
        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    dom.authCheckScreen.style.display = 'none';
                    dom.quizContainer.style.display = 'block';
                    showPaperSelection();
                } else {
                    dom.authCheckScreen.innerHTML = `<div class="text-center p-5 bg-white rounded-xl shadow-lg"><h1 class="text-3xl font-bold mb-4">Access Denied</h1><p class="text-gray-600">You must be logged in. Redirecting...</p></div>`;
                    setTimeout(() => { window.location.href = '../'; }, 3000);
                }
            });
            initEventListeners();
        });

        function initEventListeners() {
            dom.homeBtn.addEventListener('click', goHome);
            dom.restartQuizBtn.addEventListener('click', restartQuiz);
            dom.reviewAllBtn.addEventListener('click', () => reviewAnswers('all'));
            dom.reviewIncorrectBtn.addEventListener('click', () => reviewAnswers('incorrect'));
            dom.reviewBookmarkedBtn.addEventListener('click', () => reviewAnswers('bookmarked'));
        }

        // --- UI Flow & Screen Management ---
        function showPaperSelection() {
            dom.paperSelection.style.display = 'block';
            dom.mainQuizContent.style.display = 'none';
            dom.resultContainer.style.display = 'none';
            renderPaperSelectionCards();
        }

        function renderPaperSelectionCards() {
            dom.paperCardGrid.innerHTML = '';
            paperMetadata.forEach(paper => {
                const card = document.createElement('div');
                card.className = 'paper-card';
                card.innerHTML = `<div class="paper-card-icon ${paper.bgColor}">${paper.displayNumber}</div><h3 class="text-lg font-semibold">${paper.name}</h3>`;
                card.addEventListener('click', () => selectPaper(paper.id));
                dom.paperCardGrid.appendChild(card);
            });
        }

        // --- Data Fetching & Parsing ---
        async function fetchQuizDataFromSheet(sheetId, gid) {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}`;
            try {
                const response = await fetch(url);
                const csvText = await response.text();
                return parseCsvToQuestions(csvText);
            } catch (error) { console.error("Failed to fetch data:", error); return []; }
        }

        function parseCsvToQuestions(csvText) {
            const lines = csvText.trim().split('\n').slice(1); // Skip header row
            return lines.map((line, index) => {
                const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(p => p.trim().replace(/^"|"$/g, ''));
                const [question, a, b, c, d, correctAns, explanation, imgQ, imgE] = parts;
                const options = [a, b, c, d].filter(Boolean);
                const letterMap = {'a': 0, 'b': 1, 'c': 2, 'd': 3};
                const correctIndex = letterMap[(correctAns || '').trim().toLowerCase()];
                if (question && correctIndex !== undefined && options.length > 0) {
                    return { id: index, text: question, options, correctIndex, explanation, imagesrc_question: imgQ, imagesrc_explanation: imgE };
                }
                return null;
            }).filter(Boolean);
        }

        // --- Quiz Logic ---
        async function selectPaper(paperId) {
            currentPaperId = paperId;
            dom.paperSelection.style.display = 'none';
            dom.mainQuizContent.style.display = 'block';
            dom.questionContainer.innerHTML = `<div class="text-center p-5"><div class="spinner-border"></div><p class="mt-2">Loading Paper...</p></div>`;

            const [quizData, _] = await Promise.all([
                fetchQuizDataFromSheet(allQuizData[paperId].sheetId, allQuizData[paperId].gid),
                fetchUserBookmarks()
            ]);
            
            currentQuizData = quizData;
            if (currentQuizData.length === 0) { alert("No questions loaded."); showPaperSelection(); return; }

            const savedState = loadStateFromLocalStorage();
            if (savedState) {
                const resumeModal = new bootstrap.Modal(document.getElementById('resumePromptModal'));
                document.getElementById('resumeBtn').onclick = () => { resumeModal.hide(); startQuiz(savedState); };
                document.getElementById('startNewBtn').onclick = () => { resumeModal.hide(); startQuiz(null); };
                resumeModal.show();
            } else {
                startQuiz(null);
            }
        }

        function startQuiz(savedState) {
            Object.assign(state, {
                currentQuestion: 0, answers: Array(currentQuizData.length).fill(null),
                submitted: false, timePerQuestion: Array(currentQuizData.length).fill(0),
                markedForReview: []
            });
            reviewFilter = [];
            
            if (savedState) {
                state.answers = savedState.answers;
                state.markedForReview = savedState.markedForReview || [];
            }
            
            dom.resultContainer.style.display = 'none';
            dom.currentPaperDisplay.textContent = paperMetadata.find(p => p.id === currentPaperId)?.name || '';
            createNumberedNav();
            renderQuestion(0);
        }

        function renderQuestion(idx) {
            if (reviewFilter.length > 0) {
                // Handle review mode navigation by finding the position in the filtered array
                const reviewIndex = reviewFilter.indexOf(idx);
                if (reviewIndex === -1) { idx = reviewFilter[0]; } // Fallback to start of review if something goes wrong
                state.currentQuestion = idx; // Store original index
            } else {
                state.currentQuestion = idx;
            }

            const q = currentQuizData.find(q => q.id === idx);
            if (!q) return;

            const isBookmarked = userBookmarks.has(`${currentPaperId}_q${q.id}`);
            const isFlagged = state.markedForReview.includes(q.id);
            let html = `<div class="card question-card"><div class="card-body p-4">
                <h5 class="card-title mb-3 d-flex justify-content-between align-items-center">
                    <span>Question ${idx + 1} of ${currentQuizData.length}</span>
                    <div class="d-flex align-items-center">
                        <button class="icon-btn flag-btn ${isFlagged ? 'flagged' : ''}" title="Mark for Review" onclick="window.toggleMarkForReview(${q.id})"><i class="fas fa-flag"></i></button>
                        <button class="icon-btn bookmark-btn ${isBookmarked ? 'bookmarked' : ''}" title="Bookmark" onclick="window.toggleBookmark('${currentPaperId}_q${q.id}')"><i class="fas fa-bookmark"></i></button>
                    </div>
                </h5>
                <p class="question-text mb-4 fw-bold">${q.text}</p>
                ${q.imagesrc_question ? `<img src="${q.imagesrc_question}" alt="Question Image" class="question-image">` : ''}
                <div class="options">`;

            const answered = state.answers[q.id] !== null;
            q.options.forEach((option, optionIdx) => {
                let btnClass = 'option-btn w-100';
                if (answered || state.submitted) {
                    if (optionIdx === q.correctIndex) btnClass += ' correct';
                    else if (optionIdx === state.answers[q.id]) btnClass += ' incorrect';
                }
                html += `<button class="${btnClass}" data-index="${optionIdx}" ${answered || state.submitted ? 'disabled' : ''}>${option}</button>`;
            });

            html += `</div>`;
            if (answered || state.submitted) {
                html += `<div class="explanation mt-3"><h6><i class="fas fa-lightbulb me-2"></i>Explanation</h6><p>${q.explanation || 'No explanation available.'}</p>${q.imagesrc_explanation ? `<img src="${q.imagesrc_explanation}" alt="Explanation Image" class="explanation-image">` : ''}</div>`;
            }
            
            const navHtml = reviewFilter.length > 0 ? createReviewNavButtons() : createQuizNavButtons();
            html += `${navHtml}</div></div>`;

            dom.questionContainer.innerHTML = html;
            if (!state.submitted) {
                dom.questionContainer.querySelectorAll('.option-btn:not([disabled])').forEach(button => {
                    button.addEventListener('click', e => selectOption(q.id, parseInt(e.target.dataset.index)));
                });
            }
            updateQuestionNav();
        }
        
        function selectOption(qId, optionIdx) {
            if (state.answers[qId] !== null) return;
            sounds.click.play();
            state.answers[qId] = optionIdx;
            
            if (optionIdx === currentQuizData[qId].correctIndex) sounds.correct.play();
            else sounds.wrong.play();
            
            saveStateToLocalStorage();
            renderQuestion(qId);
        }

        // --- Navigation & UI Updates ---
        window.navigateToQuestion = (index) => renderQuestion(index);
        window.toggleBookmark = (bookmarkId) => toggleBookmark(bookmarkId);
        window.toggleMarkForReview = (questionId) => {
            const index = state.markedForReview.indexOf(questionId);
            if (index > -1) state.markedForReview.splice(index, 1);
            else state.markedForReview.push(questionId);
            saveStateToLocalStorage();
            renderQuestion(questionId);
        };

        function createQuizNavButtons() {
            const idx = state.currentQuestion;
            const nextAction = (idx === currentQuizData.length - 1) ? `showResults()` : `MapsToQuestion(${idx + 1})`;
            const nextText = (idx === currentQuizData.length - 1) ? 'Finish Quiz' : 'Next';
            return `<div class="d-flex justify-content-between mt-4">
                <button class="btn btn-secondary" onclick="navigateToQuestion(${idx - 1})" ${idx === 0 ? 'disabled' : ''}>Previous</button>
                <button class="btn btn-primary" onclick="${nextAction}">${nextText}</button>
            </div>`;
        }
        
        function createReviewNavButtons() {
            const currentReviewIndex = reviewFilter.indexOf(state.currentQuestion);
            const prevIdx = currentReviewIndex > 0 ? reviewFilter[currentReviewIndex - 1] : -1;
            const nextIdx = currentReviewIndex < reviewFilter.length - 1 ? reviewFilter[currentReviewIndex + 1] : -1;
            return `<div class="d-flex justify-content-between mt-4">
                <button class="btn btn-secondary" onclick="navigateToQuestion(${prevIdx})" ${prevIdx === -1 ? 'disabled' : ''}>Previous</button>
                <button class="btn btn-primary" onclick="navigateToQuestion(${nextIdx})" ${nextIdx === -1 ? 'disabled' : ''}>Next</button>
            </div>`;
        }

        function updateQuestionNav() {
            dom.questionNav.innerHTML = '';
            const navIds = reviewFilter.length > 0 ? reviewFilter : currentQuizData.map(q => q.id);
            navIds.forEach(idx => {
                const q = currentQuizData.find(q => q.id === idx);
                const box = document.createElement('div');
                box.className = 'page-box';
                box.textContent = idx + 1;
                box.onclick = () => renderQuestion(idx);
                if (idx === state.currentQuestion) box.classList.add('active');
                if (state.answers[idx] !== null) box.classList.add(state.answers[idx] === q.correctIndex ? 'correct' : 'incorrect');
                if (state.markedForReview.includes(q.id)) box.classList.add('marked-for-review');
                dom.questionNav.appendChild(box);
            });
            const answeredCount = state.answers.filter(a => a !== null).length;
            dom.practiceProgress.style.width = `${(answeredCount / currentQuizData.length) * 100}%`;
        }
        
        // --- Results & Review ---
        function showResults() {
            state.submitted = true;
            dom.mainQuizContent.style.display = 'none';
            dom.resultContainer.style.display = 'block';
            localStorage.removeItem(`quizState_${currentPaperId}`);

            let correct = 0, incorrect = 0;
            state.answers.forEach((ans, idx) => {
                if (ans !== null) {
                    if (ans === currentQuizData[idx].correctIndex) correct++;
                    else incorrect++;
                }
            });
            const unattempted = currentQuizData.length - (correct + incorrect);
            const scorePercentage = currentQuizData.length > 0 ? (correct / currentQuizData.length * 100) : 0;
            
            document.getElementById('scoreDisplay').innerHTML = `${scorePercentage.toFixed(1)}%`;
            document.getElementById('totalQuestions').textContent = currentQuizData.length;
            document.getElementById('correctAnswers').textContent = correct;
            document.getElementById('incorrectAnswers').textContent = incorrect;
            document.getElementById('unattempted').textContent = unattempted;

            createPerformanceChart({ correct, incorrect, unattempted });
            if (scorePercentage >= 70) createConfetti();
        }

        function reviewAnswers(filter) {
            reviewFilter = [];
            if (filter === 'all') {
                reviewFilter = currentQuizData.map(q => q.id);
            } else if (filter === 'incorrect') {
                state.answers.forEach((ans, idx) => {
                    if (ans !== null && ans !== currentQuizData[idx].correctIndex) reviewFilter.push(currentQuizData[idx].id);
                });
            } else if (filter === 'bookmarked') {
                currentQuizData.forEach((q) => {
                    if (userBookmarks.has(`${currentPaperId}_q${q.id}`)) reviewFilter.push(q.id);
                });
            }

            if (reviewFilter.length === 0) { alert(`No ${filter} questions to review.`); return; }
            
            state.submitted = true;
            dom.resultContainer.style.display = 'none';
            dom.mainQuizContent.style.display = 'block';
            renderQuestion(reviewFilter[0]);
        }
        
        function goHome() { reviewFilter = []; state.submitted = false; showPaperSelection(); }
        function restartQuiz() { localStorage.removeItem(`quizState_${currentPaperId}`); selectPaper(currentPaperId); }

        // --- Local Storage for Resume ---
        function saveStateToLocalStorage() {
            const stateToSave = { answers: state.answers, markedForReview: state.markedForReview };
            localStorage.setItem(`quizState_${currentPaperId}`, JSON.stringify(stateToSave));
        }
        function loadStateFromLocalStorage() {
            const savedStateJSON = localStorage.getItem(`quizState_${currentPaperId}`);
            return savedStateJSON ? JSON.parse(savedStateJSON) : null;
        }

        // --- Bookmarks ---
        async function fetchUserBookmarks() {
            if (!currentUser) return;
            const bookmarksRef = collection(db, "users", currentUser.uid, "bookmarks");
            const snapshot = await getDocs(bookmarksRef);
            userBookmarks = new Set(snapshot.docs.map(doc => doc.id));
        }
        async function toggleBookmark(bookmarkId) {
            if (!currentUser) return alert("You must be logged in.");
            const bookmarkRef = doc(db, "users", currentUser.uid, "bookmarks", bookmarkId);
            const questionId = parseInt(bookmarkId.split('_q')[1]);
            const questionData = currentQuizData.find(q => q.id === questionId);
            
            if (userBookmarks.has(bookmarkId)) {
                await deleteDoc(bookmarkRef);
                userBookmarks.delete(bookmarkId);
            } else {
                await setDoc(bookmarkRef, {
                    questionText: questionData.text, paperId: currentPaperId, timestamp: serverTimestamp()
                });
                userBookmarks.add(bookmarkId);
            }
            renderQuestion(questionId);
        }
        
        // --- Chart & Animation ---
        function createPerformanceChart(results) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (window.performanceChartInstance) window.performanceChartInstance.destroy();
            window.performanceChartInstance = new Chart(ctx, {
                type: 'doughnut', data: { labels: ['Correct', 'Incorrect', 'Unattempted'], datasets: [{ data: [results.correct, results.incorrect, results.unattempted], backgroundColor: ['#28a745', '#dc3545', '#ffc107'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }
        function createConfetti() {
            for (let i = 0; i < 150; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.left = Math.random() * 100 + 'vw';
                document.body.appendChild(confetti);
                const anim = confetti.animate([ { transform: 'translateY(0) rotate(0)', opacity: 1 }, { transform: `translateY(${Math.random() * 500 + 500}px) rotate(${Math.random() * 360}deg)`, opacity: 0 }], { duration: Math.random() * 3000 + 2000, easing: 'cubic-bezier(.23,1,.32,1)' });
                anim.onfinish = () => confetti.remove();
            }
        }
    </script>
</body>
</html>
