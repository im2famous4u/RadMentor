<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fellowship Exams Quiz - RadScribe AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        /* Base Body and Glass Card styles */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .glass-card {
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05), 0 6px 6px rgba(0,0,0,0.03);
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        /* Adapted Quiz Styles */
        .quiz-container {
            max-width: 800px;
            margin: 0 auto;
            background: transparent;
            border-radius: 15px;
            box-shadow: none;
            overflow: hidden;
            animation: fadeIn 0.5s;
            touch-action: pan-y;
            display: flex;
            flex-direction: column;
        }
        @keyframes fadeIn {from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        @keyframes slideIn {from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1)}}

        .quiz-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: white;
            padding: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            position: relative;
            border-radius: 1.5rem 1.5rem 0 0;
        }
        .question-card {
            border:none;
            box-shadow:0 5px 20px rgba(0,0,0,0.06);
            margin-bottom:25px;
            border-radius:15px;
            overflow:hidden;
            transition:all 0.4s ease;
            animation:slideIn 0.4s;
            background-color: #ffffff;
        }
        .option-btn {
            text-align:left;
            padding:16px 20px;
            margin-bottom:12px;
            border-radius:12px;
            transition:all 0.3s ease;
            position:relative;
            overflow:hidden;
            border:1px solid #e2e8f0;
            background-color: #f8fafc;
            color: #333;
        }
        .option-btn:hover {background-color:#e2e8f0;transform:translateX(5px);box-shadow:0 3px 10px rgba(0,0,0,0.05)}
        .option-btn.selected {background-color:#fce7f3;border-color:#f472b6;font-weight:500;box-shadow:0 5px 15px rgba(236,72,153,0.15); color: #333;}
        .option-btn.correct {background-color:#dcfce7;border-color:#4ade80; color: #166534;}
        .option-btn.incorrect {background-color:#fee2e2;border-color:#f87171; color: #b91c1c;}
        
        .quiz-pagination {display:flex;justify-content:center;flex-wrap:wrap;gap:10px;margin:15px 0;padding:10px 0}
        .quiz-pagination .page-box {width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:600;background-color:#f8fafc;color:#555;border:1px solid #e2e8f0;cursor:pointer;transition:all 0.3s ease; border-radius: 0.5rem;}
        .quiz-pagination .page-box.active {background-color:#ec4899;border-color:#ec4899;color:white}
        .quiz-pagination .page-box:hover {transform:scale(1.1)}
        .quiz-pagination .page-box.correct {background-color:#28a745;border-color:#28a745;color:white}
        .quiz-pagination .page-box.incorrect {background-color:#dc3545;border-color:#dc3545;color:white}
        
        .explanation {background-color:#f8fafc;padding:15px;border-radius:8px;margin-top:15px;border-left:3px solid #ec4899; color: #333;}
        
        .result-card {display:none;animation:fadeIn 0.5s; background-color: #ffffff; border-radius: 1.5rem; padding: 2rem;}
        .score-highlight {font-size:48px;font-weight:700;color:#ec4899;text-align:center;margin:20px 0}

        .btn-primary {background-color:#ec4899;border-color:#ec4899;border-radius:30px;padding:10px 25px;transition:all 0.3s ease; color: white;}
        .btn-primary:hover {background-color:#be185d;border-color:#be185d;transform:translateY(-3px);box-shadow:0 5px 15px rgba(236,72,153,0.2)}
        .btn-secondary {background-color:#6b7280;border-color:#6b7280;border-radius:30px;padding:10px 25px;transition:all 0.3s ease; color: white;}
        .btn-secondary:hover {background-color:#4b5563;border-color:#4b5563;transform:translateY(-3px);box-shadow:0 5px 15px rgba(107,114,128,0.2)}
        .btn-info {background-color:#0ea5e9;border-color:#0ea5e9;border-radius:30px;padding:10px 25px;transition:all 0.3s ease; color: white;}
        .btn-info:hover {background-color:#0284c7;border-color:#0284c7;transform:translateY(-3px);box-shadow:0 5px 15px rgba(14,165,233,0.2)}

        .question-image, .explanation-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        #paperSelectionContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            padding: 20px;
            text-align: center;
        }
        .quiz-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1001;
        }
        
        /* --- Bookmark Styles --- */
        .bookmark-btn {
            font-size: 1.5rem;
            cursor: pointer;
            color: #d1d5db; /* Gray when not bookmarked */
            transition: color 0.2s ease-in-out, transform 0.2s ease;
        }
        .bookmark-btn:hover {
            color: #eab308; /* Yellow on hover */
            transform: scale(1.1);
        }
        .bookmark-btn.bookmarked {
            color: #f59e0b; /* Bright gold when bookmarked */
        }
        
        /* --- Paper Card Styles --- */
        .paper-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .paper-card {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 1px solid #e2e8f0;
        }
        .paper-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            border-color: #ec4899;
        }
        .paper-card-icon {
            width: 60px; height: 60px;
            display: flex; justify-content: center; align-items: center;
            border-radius: 50%;
            margin-bottom: 1rem;
            font-size: 2rem; font-weight: 700;
        }
        .paper-card-icon.bg-blue-100 { background-color: #e0f2fe; color: #3b82f6; }
        .paper-card-icon.bg-pink-100 { background-color: #fdf2f8; color: #ec4899; }
        
        /* Auth check screen */
        #authCheckScreen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f0f2f5;
            z-index: 9999;
        }
    </style>
</head>
<body>

    <div id="authCheckScreen">
        <div class="text-center p-5 bg-white rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold mb-4">Verifying Access...</h1>
            <p class="text-gray-600">Please wait while we check your login status.</p>
            <div class="spinner-border text-pink-500 mt-4" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <div class="container my-4">
        <div class="quiz-container glass-card" id="quizContainer" style="display: none;">
            <h1 class="text-3xl font-extrabold text-gray-900 text-center mb-6">Fellowship Exam Quiz</h1>

            <div id="paperSelectionContainer">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Select a Paper to Begin</h2>
                <div id="paper-card-grid" class="paper-card-grid">
                    </div>
                <div class="d-flex justify-content-center mt-5">
                     <a href="dashboard/bookmark.html" class="btn btn-info btn-lg px-5 py-2 rounded-pill shadow">
                        <i class="fas fa-bookmark me-2"></i>My Bookmarks
                    </a>
                </div>
            </div>

            <div id="mainQuizContent" style="display: none;">
                <div class="quiz-header shadow-sm">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="m-0 fw-bold">Paper <span id="currentPaperDisplay"></span></h2>
                        <div class="quiz-controls">
                            <button id="homeBtn" class="btn btn-secondary btn-sm">
                                <i class="fas fa-home me-1"></i> Home
                            </button>
                        </div>
                    </div>
                    <div class="progress mt-3">
                        <div id="practiceProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" style="width:0%"></div>
                    </div>
                </div>

                <div class="p-4">
                    <div id="questionContainer"></div>
                    <div class="quiz-pagination" id="questionNav"></div>
                </div>
            </div>

            <div id="resultContainer" class="result-card p-4" style="display: none;">
                 <h3 class="text-center fw-bold mb-4">Quiz Results</h3>
                 <div class="score-highlight" id="scoreDisplay"></div>
                 <div class="d-flex justify-content-center mt-4">
                    <button id="reviewBtn" class="btn btn-primary btn-lg px-5 py-2 rounded-pill shadow">View Solution</button>
                    <button id="restartQuizBtn" class="btn btn-secondary btn-lg px-5 py-2 rounded-pill shadow ms-3">Restart Quiz</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";

        // IMPORTANT: Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // --- Data Configuration ---
        const allQuizData = {
            paper1: { sheetId: "13bIVTjrFwqcP0Q7WitSvb3ksy7g9XWXrq4uLOQwzLmo", gid: "0" },
            paper2: { sheetId: "13bIVTjrFwqcP0Q7WitSvb3ksy7g9XWXrq4uLOQwzLmo", gid: "1141721868" },
            // Add other papers here
        };

        const paperMetadata = [
            { id: 'paper1', name: 'Paper 1', displayNumber: 1, totalQuestions: 80, bgColor: 'bg-blue-100' },
            { id: 'paper2', name: 'Paper 2', displayNumber: 2, totalQuestions: 80, bgColor: 'bg-pink-100' },
            // Add metadata for other papers
        ];
        
        // --- Global State ---
        let currentQuizData = [];
        let currentPaperId = '';
        let currentUser = null;
        let userBookmarks = new Set();
        const state = {
            currentQuestion: 0,
            answers: [],
            submitted: false,
        };

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const authCheckScreen = document.getElementById('authCheckScreen');
        const quizContainer = document.getElementById('quizContainer');
        const paperSelectionContainer = document.getElementById('paperSelectionContainer');
        const mainQuizContent = document.getElementById('mainQuizContent');
        const resultContainer = document.getElementById('resultContainer');
        const questionContainer = document.getElementById('questionContainer');
        const questionNav = document.getElementById('questionNav');
        const homeBtn = document.getElementById('homeBtn');
        const reviewBtn = document.getElementById('reviewBtn');
        const restartQuizBtn = document.getElementById('restartQuizBtn');
        
        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    authCheckScreen.style.display = 'none';
                    quizContainer.style.display = 'block';
                    showPaperSelection();
                } else {
                    authCheckScreen.innerHTML = `<div class="text-center p-5 bg-white rounded-xl shadow-lg">
                        <h1 class="text-3xl font-bold mb-4">Access Denied</h1>
                        <p class="text-gray-600">You must be logged in to take the quiz. Redirecting...</p>
                    </div>`;
                    setTimeout(() => { window.location.href = '../'; }, 3000); // Redirect to your main login page
                }
            });
            initEventListeners();
        });

        function initEventListeners() {
            homeBtn.addEventListener('click', showPaperSelection);
            reviewBtn.addEventListener('click', reviewAnswers);
            restartQuizBtn.addEventListener('click', () => selectPaper(currentPaperId));
        }

        function showPaperSelection() {
            paperSelectionContainer.style.display = 'block';
            mainQuizContent.style.display = 'none';
            resultContainer.style.display = 'none';
            renderPaperSelectionCards();
        }

        function renderPaperSelectionCards() {
            const grid = document.getElementById('paper-card-grid');
            grid.innerHTML = '';
            paperMetadata.forEach(paper => {
                const card = document.createElement('div');
                card.className = 'paper-card';
                card.innerHTML = `
                    <div class="paper-card-icon ${paper.bgColor}">${paper.displayNumber}</div>
                    <h3 class="text-lg font-semibold">${paper.name}</h3>
                `;
                card.addEventListener('click', () => selectPaper(paper.id));
                grid.appendChild(card);
            });
        }
        
        // --- Data Fetching and Parsing ---
        async function fetchQuizDataFromSheet(sheetId, gid) {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&gid=${gid}`;
            try {
                const response = await fetch(url);
                const csvText = await response.text();
                return parseCsvToQuestions(csvText);
            } catch (error) {
                console.error("Failed to fetch data:", error);
                return [];
            }
        }

        function parseCsvToQuestions(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            const dataRows = lines.slice(1);
            
            // Map headers from your Excel sheet to object keys
            const headerMap = {
                question: headers.indexOf('question'),
                optionA: headers.indexOf('a'),
                optionB: headers.indexOf('b'),
                optionC: headers.indexOf('c'),
                optionD: headers.indexOf('d'),
                correctAnswer: headers.indexOf('Correct Answe'), // As seen in your screenshot
                explanation: headers.indexOf('Explanation'),
                imageQuestion: headers.indexOf('Image for Que'),
                imageExplanation: headers.indexOf('Explanation Im')
            };
            
            const questions = [];
            dataRows.forEach((line) => {
                const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(p => p.trim().replace(/^"|"$/g, ''));
                if (parts.length < headers.length) return;
                
                const questionText = parts[headerMap.question];
                const options = [
                    parts[headerMap.optionA], parts[headerMap.optionB],
                    parts[headerMap.optionC], parts[headerMap.optionD]
                ].filter(Boolean); // Filter out empty options

                // *** CRITICAL FIX HERE ***
                // Maps the answer letter ('a', 'b', etc.) to the correct index (0, 1, etc.)
                const correctAnswerLetter = (parts[headerMap.correctAnswer] || '').trim().toLowerCase();
                const letterMap = {'a': 0, 'b': 1, 'c': 2, 'd': 3};
                const correctIndex = letterMap[correctAnswerLetter];

                if (questionText && correctIndex !== undefined && options.length > 0) {
                    questions.push({
                        id: questions.length,
                        text: questionText,
                        options: options,
                        correctIndex: correctIndex,
                        explanation: parts[headerMap.explanation] || 'No explanation provided.',
                        imagesrc_question: parts[headerMap.imageQuestion] || '',
                        imagesrc_explanation: parts[headerMap.imageExplanation] || ''
                    });
                }
            });
            return questions;
        }
        
        // --- Quiz Logic ---
        async function selectPaper(paperId) {
            currentPaperId = paperId;
            const paperInfo = allQuizData[paperId];
            if (!paperInfo) { alert("Paper data not found."); return; }
            
            // Show loading state
            paperSelectionContainer.style.display = 'none';
            mainQuizContent.style.display = 'block';
            questionContainer.innerHTML = `<div class="text-center"><div class="spinner-border"></div><p>Loading...</p></div>`;
            
            // Fetch quiz data and user bookmarks simultaneously
            const [quizData, _] = await Promise.all([
                fetchQuizDataFromSheet(paperInfo.sheetId, paperInfo.gid),
                fetchUserBookmarks()
            ]);

            currentQuizData = quizData;
            if (currentQuizData.length === 0) {
                alert("No questions loaded. Please check the data source.");
                showPaperSelection();
                return;
            }

            // Reset state for new quiz
            state.currentQuestion = 0;
            state.answers = Array(currentQuizData.length).fill(null);
            state.submitted = false;
            
            resultContainer.style.display = 'none';
            document.getElementById('currentPaperDisplay').textContent = paperMetadata.find(p => p.id === paperId)?.name || '';

            createNumberedNav();
            renderQuestion(0);
        }

        function createNumberedNav() {
            questionNav.innerHTML = '';
            currentQuizData.forEach((_, idx) => {
                const box = document.createElement('div');
                box.className = 'page-box';
                box.textContent = idx + 1;
                box.dataset.index = idx;
                box.addEventListener('click', () => renderQuestion(idx));
                questionNav.appendChild(box);
            });
        }

        function renderQuestion(idx) {
            if (idx < 0 || idx >= currentQuizData.length) return;
            state.currentQuestion = idx;
            const q = currentQuizData[idx];

            const isBookmarked = userBookmarks.has(`${currentPaperId}_q${q.id}`);
            let html = `
                <div class="card question-card">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-3 d-flex justify-content-between align-items-center">
                            <span>Question ${idx + 1} of ${currentQuizData.length}</span>
                            <i class="fas fa-bookmark bookmark-btn ${isBookmarked ? 'bookmarked' : ''}" 
                               title="Toggle Bookmark"
                               onclick="window.toggleBookmark('${currentPaperId}_q${q.id}')"></i>
                        </h5>
                        <p class="question-text mb-4 fw-bold">${q.text}</p>
                        ${q.imagesrc_question ? `<img src="${q.imagesrc_question}" alt="Question Image" class="question-image">` : ''}
                        <div class="options">`;
            
            const answered = state.answers[idx] !== null;
            q.options.forEach((option, optionIdx) => {
                let btnClass = 'option-btn w-100';
                if (answered) {
                    if (optionIdx === q.correctIndex) btnClass += ' correct';
                    else if (optionIdx === state.answers[idx]) btnClass += ' incorrect';
                }
                html += `<button class="${btnClass}" data-index="${optionIdx}" ${answered ? 'disabled' : ''}>${option}</button>`;
            });

            html += `</div>`;
            if (answered) {
                html += `<div class="explanation mt-3">
                    <h6 class="fw-bold"><i class="fas fa-lightbulb me-2"></i>Explanation</h6>
                    <p>${q.explanation}</p>
                    ${q.imagesrc_explanation ? `<img src="${q.imagesrc_explanation}" alt="Explanation Image" class="explanation-image">` : ''}
                </div>`;
            }
            html += `</div></div>`;
            
            // Navigation buttons
            html += `<div class="d-flex justify-content-between mt-4">
                <button class="btn btn-secondary" onclick="renderQuestion(${idx - 1})" ${idx === 0 ? 'disabled' : ''}>Previous</button>
                ${idx === currentQuizData.length - 1 ? 
                  `<button class="btn btn-primary" onclick="showResults()">Finish Quiz</button>` :
                  `<button class="btn btn-primary" onclick="renderQuestion(${idx + 1})">Next</button>`
                }
            </div>`;

            questionContainer.innerHTML = html;
            
            document.querySelectorAll('.option-btn:not([disabled])').forEach(button => {
                button.addEventListener('click', e => selectOption(parseInt(e.target.dataset.index)));
            });
            updateQuestionNav();
        }

        function selectOption(optionIdx) {
            if (state.answers[state.currentQuestion] !== null) return;
            state.answers[state.currentQuestion] = optionIdx;
            
            // Re-render the question to show feedback
            renderQuestion(state.currentQuestion);
        }

        function updateQuestionNav() {
            document.querySelectorAll('#questionNav .page-box').forEach(box => {
                const idx = parseInt(box.dataset.index);
                box.classList.remove('active', 'correct', 'incorrect');
                if (idx === state.currentQuestion) box.classList.add('active');
                if (state.answers[idx] !== null) {
                    box.classList.add(state.answers[idx] === currentQuizData[idx].correctIndex ? 'correct' : 'incorrect');
                }
            });
            // Update progress bar
            const answeredCount = state.answers.filter(a => a !== null).length;
            const progress = (answeredCount / currentQuizData.length) * 100;
            document.getElementById('practiceProgress').style.width = `${progress}%`;
        }

        function showResults() {
            state.submitted = true;
            mainQuizContent.style.display = 'none';
            resultContainer.style.display = 'block';

            let correct = 0;
            state.answers.forEach((ans, idx) => {
                if (ans === currentQuizData[idx].correctIndex) correct++;
            });
            const attempted = state.answers.filter(a => a !== null).length;
            const percentage = attempted > 0 ? (correct / attempted * 100).toFixed(1) : 0;
            
            document.getElementById('scoreDisplay').innerHTML = `${correct} / ${attempted} (${percentage}%)`;
            // You can add more detailed results here if needed
        }

        function reviewAnswers() {
            mainQuizContent.style.display = 'block';
            resultContainer.style.display = 'none';
            renderQuestion(0);
        }

        // --- Bookmark Functions ---
        async function fetchUserBookmarks() {
            if (!currentUser) return;
            const bookmarksRef = collection(db, "users", currentUser.uid, "bookmarks");
            try {
                const snapshot = await getDocs(bookmarksRef);
                userBookmarks = new Set(snapshot.docs.map(doc => doc.id));
            } catch (error) {
                console.error("Could not fetch bookmarks:", error);
                userBookmarks = new Set();
            }
        }
        
        // Make this function globally accessible for the onclick attribute
        window.toggleBookmark = async (questionId) => {
            if (!currentUser) {
                alert("You must be logged in to bookmark questions.");
                return;
            }
            
            const bookmarkButton = document.querySelector(`[onclick*="'${questionId}'"]`);
            const bookmarkRef = doc(db, "users", currentUser.uid, "bookmarks", questionId);
            const isBookmarked = userBookmarks.has(questionId);

            try {
                if (isBookmarked) {
                    await deleteDoc(bookmarkRef);
                    userBookmarks.delete(questionId);
                    bookmarkButton.classList.remove('bookmarked');
                } else {
                    // Find question text to save it for context in the bookmarks page
                    const q_index = parseInt(questionId.split('_q')[1]);
                    const questionData = currentQuizData[q_index];
                    
                    await setDoc(bookmarkRef, {
                        paperId: currentPaperId,
                        questionId: questionId,
                        questionText: questionData.text,
                        timestamp: serverTimestamp()
                    });
                    userBookmarks.add(questionId);
                    bookmarkButton.classList.add('bookmarked');
                }
            } catch(error) {
                console.error("Error toggling bookmark:", error);
                alert("Could not update bookmark. Please try again.");
            }
        };

    </script>
</body>
</html>
