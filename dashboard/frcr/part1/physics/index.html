<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>FRCR Physics Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        /* --- Base & Theme from Reference --- */
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --background-color: #f0f4f8;
            --card-background: rgba(255, 255, 255, 0.7);
            --text-primary: #1a202c;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 1rem;
        }

        .main-container {
            width: 100%;
            max-width: 900px;
        }

        .glass-card {
            background-color: var(--card-background);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05), 0 6px 6px rgba(0,0,0,0.03);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* --- Screen Management --- */
        .screen { display: none; width: 100%; }
        .screen.active { display: block; }

        /* --- Shared Components from Reference --- */
        .selection-container, .quiz-container {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.07);
        }

        .quiz-header {
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quiz-header h1 {
            font-size: 2.2rem;
            margin: 0;
            color: var(--text-primary);
            font-weight: 800;
        }

        .back-button {
            background-color: transparent;
            color: #4a5568;
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .back-button:hover { background-color: #f0f4f8; }

        /* --- Home and Category Screen --- */
        .selection-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem; 
        }

        .topic-card {
            background-color: #ffffff;
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
            text-align: left;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

        .topic-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            flex-shrink: 0;
        }
        .icon-bg-blue { background-color: #e0f2fe; color: #2196f3; }
        .icon-bg-orange { background-color: #fff3e0; color: #ff9800; }
        .icon-bg-pink { background-color: #fce4ec; color: #e91e63; }
        .icon-bg-green { background-color: #e8f5e9; color: #4caf50; }
        .icon-bg-yellow { background-color: #fffde7; color: #ffeb3b; }
        .icon-bg-purple { background-color: #ede7f6; color: #9c27b0; }

        .topic-info { flex-grow: 1; }
        .topic-info .topic-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #2d3748;
            margin-bottom: 4px;
        }
        .topic-info .completion-status {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .topic-arrow { font-size: 1.5rem; color: #a0aec0; }

        .view-bookmarks-button {
            display: block;
            width: 100%;
            margin-top: 1.5rem;
            padding: 1rem;
            font-weight: 600;
            background-color: #f8fafc;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            text-align: center;
            transition: background-color 0.2s;
        }
        .view-bookmarks-button:hover { background-color: #f1f5f9; }

        /* --- Quiz View Styles --- */
        .loading-container, .error-container { text-align: center; padding: 3rem; font-size: 1.1rem; color: var(--text-secondary); }
        .error-container { color: #c53030; background-color: #fed7d7; border: 1px solid #fbb6b6; border-radius: 8px; }

        .question-block { padding: 0.5rem; }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .question-number { font-size: 1rem; font-weight: 600; color: var(--text-secondary); }
        
        .bookmark-button {
            background: none; border: none; cursor: pointer; color: #cbd5e0; transition: color 0.2s;
        }
        .bookmark-button.bookmarked { color: #f59e0b; }
        .bookmark-button svg { width: 24px; height: 24px; }

        .main-question-text {
            font-size: 1.5rem;
            font-weight: 600;
            line-height: 1.5;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .question-options label {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .question-options label:hover { background-color: #f8fafc; }
        .question-options input[type="radio"] {
            width: 18px; height: 18px; margin-right: 1rem; flex-shrink: 0; accent-color: var(--primary-color);
        }
        .question-options label.selected-correct {
            background-color: #d1fae5; border-color: #34d399; font-weight: 600;
        }
        .question-options label.selected-incorrect {
            background-color: #fee2e2; border-color: #ef4444; font-weight: 600;
        }
        .question-options label.correct-answer {
            background-color: #e0f2fe; border-color: #60a5fa; font-weight: 600;
        }

        .all-explanations {
            margin-top: 2rem; padding: 1.5rem; background-color: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.75rem; display: none;
        }
        .all-explanations.visible { display: block; }
        .all-explanations h3 { margin-top: 0; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); color: #1e3a5f; font-weight: 700; }
        .all-explanations p { margin: 0 0 0.5rem 0; line-height: 1.6; color: var(--text-secondary); }
        .all-explanations p.font-semibold { color: var(--text-primary); }

        .navigation-controls {
            display: flex; justify-content: space-between; align-items: center; padding-top: 1.5rem; border-top: 1px solid var(--border-color); margin-top: 1.5rem;
        }
        .nav-button {
            background-color: var(--primary-color); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 0.5rem; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background-color 0.2s;
        }
        .nav-button:hover:not(:disabled) { background-color: var(--primary-hover); }
        .nav-button:disabled { background-color: #a0aec0; cursor: not-allowed; }
        #question-counter { font-size: 1rem; font-weight: 500; color: var(--text-secondary); text-align: center; padding-top: 1rem; }

        /* Bookmarks Screen Specifics */
        #bookmarks-list .loading-container { padding: 2rem; }
        .bookmark-item {
            background-color: #f8fafc;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
        }
        .bookmark-item-text .question-text { font-weight: 600; color: var(--text-primary); }
        .bookmark-item-text .topic-name { font-size: 0.8rem; color: var(--text-secondary); }
        .bookmark-remove-btn { color: var(--text-secondary); transition: color 0.2s; }
        .bookmark-remove-btn:hover { color: #ef4444; }
    </style>
</head>
<body>

    <div class="main-container glass-card">
        <!-- Auth Check Screen -->
        <div id="auth-check-screen" class="screen active">
            <div class="selection-container">
                <h1 class="font-extrabold text-2xl">Verifying User...</h1>
                <p class="text-gray-700 mt-4">Please wait while we check your login status.</p>
            </div>
        </div>

        <!-- Physics Category Screen -->
        <div id="physics-category-screen" class="screen">
            <div class="selection-container">
                <div class="quiz-header">
                    <h1>Physics Topics</h1>
                    <button class="back-button" onclick="window.parent.document.getElementById('contentFrame').src = '/fellowshipexams/frcr.html';">
                        <i data-feather="arrow-left" style="width:16px; height:16px;"></i>
                        <span>Back</span>
                    </button>
                </div>
                <div id="physics-topics-grid" class="selection-grid"></div>
                <button class="view-bookmarks-button" onclick="showBookmarksScreen()">View Bookmarks</button>
            </div>
        </div>

        <!-- Bookmarks Screen -->
        <div id="bookmarks-screen" class="screen">
            <div class="quiz-container">
                <div class="quiz-header">
                    <h1>My Bookmarks</h1>
                    <button class="back-button" onclick="showScreen('physics-category-screen')">
                        <i data-feather="arrow-left" style="width:16px; height:16px;"></i>
                        <span>Back to Topics</span>
                    </button>
                </div>
                <div id="bookmarks-list">
                    <p class="loading-container">Fetching bookmarks...</p>
                </div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="screen">
            <div class="quiz-container">
                <div class="quiz-header">
                    <h1 id="quiz-title">Physics Questions</h1>
                    <button class="back-button" id="back-to-topics-btn" onclick="showScreen('physics-category-screen')">
                        <i data-feather="arrow-left" style="width:16px; height:16px;"></i>
                        <span>Back to Topics</span>
                    </button>
                </div>
                <div id="loading-container" class="loading-container"><p>Loading questions...</p></div>
                <div id="error-container" class="error-container" style="display:none;"></div>
                <div id="questions-display"></div>
                <div id="navigation-controls" style="display: none;">
                    <button id="prev-button" class="nav-button">Previous</button>
                    <button id="next-button" class="nav-button">Next</button>
                </div>
                <div id="question-counter"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase instances and utility from your centralized auth.js
        import { auth, db, showParentMessage } from '/fellowshipexams/js/auth.js';
        // Import Firestore specific functions needed here
        import { collection, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";


        // --- Configuration ---
        const GOOGLE_SHEET_ID = '1zW9hT5Yy8vK2thzSzjqf8DdIM_b_fLjmO0jLk5J0ti8'; 
        const PHYSICS_TOPICS = [
            { name: "Basic Physics", gid: "2009849222", icon: "⚛️", color: "blue", totalModules: 54 },
            { name: "General Radiation Hazards & Protection", gid: "2009849222", icon: "☢️", color: "orange", totalModules: 49 },
            { name: "Image Quality & X-ray Production", gid: "1706416231", icon: "📸", color: "pink", totalModules: 39 },
            { name: "Film Screen Radiography", gid: "1257614317", icon: "🖼️", color: "green", totalModules: 20 },
            { name: "Digital Radiography", gid: "917881905", icon: "🖥️", color: "yellow", totalModules: 30 },
            { name: "Fluoroscopy", gid: "1461599884", icon: "�", color: "purple", totalModules: 25 },
            { name: "Computed Tomography", gid: "986205874", icon: "🩻", color: "blue", totalModules: 40 },
            { name: "Nuclear Medicine", gid: "2016453957", icon: "🧪", color: "orange", totalModules: 35 },
            { name: "Ultrasound", gid: "638565218", icon: "🔊", color: "pink", totalModules: 28 },
            { name: "Magnetic Resonance Imaging", gid: "2026917708", icon: "🧲", color: "green", totalModules: 45 },
        ];

        // --- App State ---
        let allQuestions = [];
        let currentQuestionIndex = 0;
        let currentUser = null;
        let userBookmarks = new Set();
        let currentTopic = null;

        // --- DOM Elements ---
        const screens = document.querySelectorAll('.screen');
        const authCheckScreen = document.getElementById('auth-check-screen');
        const physicsTopicsGrid = document.getElementById('physics-topics-grid');
        const quizTitle = document.getElementById('quiz-title');
        const bookmarksList = document.getElementById('bookmarks-list');
        const loadingContainer = document.getElementById('loading-container');
        const errorContainer = document.getElementById('error-container');
        const questionsDisplay = document.getElementById('questions-display');
        const navigationControls = document.getElementById('navigation-controls');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const questionCounter = document.getElementById('question-counter');

        // --- Utility Functions ---
        const showScreen = (screenId) => {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId)?.classList.add('active');
            feather.replace();
        };
        window.showScreen = showScreen;

        // --- Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                await fetchUserBookmarks(appId);
                populateTopics();
                showScreen('physics-category-screen');
            } else {
                authCheckScreen.innerHTML = `<div class="selection-container"><h1 class="text-red-600">Redirecting...</h1><p class="text-gray-700 mt-4">You must be logged in to access this page.</p></div>`;
                showParentMessage('Session expired or authentication failed. Redirecting to login.', 'error');
                setTimeout(() => { window.parent.location.href = '/fellowshipexams/index.html'; }, 2000);
            }
        });

        // --- Firestore Data Operations ---
        async function fetchUserBookmarks(appId) {
            if (!currentUser) return;
            const bookmarksRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/bookmarks`);
            try {
                const snapshot = await getDocs(bookmarksRef);
                userBookmarks = new Set(snapshot.docs.map(doc => doc.id));
            } catch (error) {
                console.error("Could not fetch bookmarks:", error);
                showParentMessage('Failed to load bookmarks.', 'error');
            }
        }

        async function toggleBookmark(questionId, questionText) {
            if (!currentUser) {
                showParentMessage('You must be logged in to bookmark questions.', 'error');
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const bookmarkDocRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/bookmarks`, questionId);
            const button = document.querySelector(`button[data-question-id="${questionId}"]`);

            try {
                if (userBookmarks.has(questionId)) {
                    await deleteDoc(bookmarkDocRef);
                    userBookmarks.delete(questionId);
                    if (button) button.classList.remove('bookmarked');
                    showParentMessage('Bookmark removed!', 'success');
                } else {
                    await setDoc(bookmarkDocRef, {
                        question: questionText,
                        topicId: currentTopic.gid,
                        topicName: currentTopic.name,
                        timestamp: serverTimestamp()
                    });
                    userBookmarks.add(questionId);
                    if (button) button.classList.add('bookmarked');
                    showParentMessage('Question bookmarked!', 'success');
                }
            } catch (error) {
                console.error("Error toggling bookmark:", error);
                showParentMessage('Failed to toggle bookmark.', 'error');
            }
        }
        window.toggleBookmark = toggleBookmark;

        async function showBookmarksScreen() {
            showScreen('bookmarks-screen');
            bookmarksList.innerHTML = '<p class="loading-container">Fetching bookmarks...</p>';

            if (!currentUser) {
                bookmarksList.innerHTML = '<p class="loading-container">You must be logged in to view bookmarks.</p>';
                return;
            }
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            try {
                const bookmarksRef = collection(db, `artifacts/${appId}/users/${currentUser.uid}/bookmarks`);
                const snapshot = await getDocs(bookmarksRef);

                if (snapshot.empty) {
                    bookmarksList.innerHTML = '<p class="loading-container">You have no bookmarked questions.</p>';
                } else {
                    let html = '<div class="space-y-4">';
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        html += `
                            <div class="bookmark-item">
                                <div class="bookmark-item-text">
                                    <p class="question-text">${data.question}</p>
                                    <p class="topic-name">Topic: ${data.topicName}</p>
                                </div>
                                <button onclick="removeBookmarkFromList('${doc.id}')" class="bookmark-remove-btn">
                                    <i data-feather="x-circle"></i>
                                </button>
                            </div>`;
                    });
                    html += '</div>';
                    bookmarksList.innerHTML = html;
                    feather.replace();
                }
            } catch (error) {
                console.error("Error fetching bookmarks:", error);
                bookmarksList.innerHTML = '<p class="error-container">Could not load bookmarks.</p>';
            }
        }
        window.showBookmarksScreen = showBookmarksScreen;
        
        async function removeBookmarkFromList(questionId) {
            if (!currentUser) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const bookmarkDocRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/bookmarks`, questionId);
            try {
                await deleteDoc(bookmarkDocRef);
                userBookmarks.delete(questionId);
                showBookmarksScreen(); // Refresh the list
                const currentBookmarkButton = document.querySelector(`.bookmark-button[data-question-id="${questionId}"]`);
                if(currentBookmarkButton) {
                    currentBookmarkButton.classList.remove('bookmarked');
                }
                showParentMessage('Bookmark removed!', 'success');
            } catch (error) {
                console.error("Error removing bookmark:", error);
                showParentMessage("Failed to remove bookmark.", 'error');
            }
        };
        window.removeBookmarkFromList = removeBookmarkFromList;

        // --- Functions (Navigation & Setup) ---
        function populateTopics() {
            physicsTopicsGrid.innerHTML = '';
            PHYSICS_TOPICS.forEach(topic => {
                const button = document.createElement('div');
                button.className = `topic-card`;
                button.innerHTML = `
                    <div class="topic-icon icon-bg-${topic.color}">
                        ${topic.icon}
                    </div>
                    <div class="topic-info">
                        <div class="topic-name">${topic.name}</div>
                        <div class="completion-status">0/${topic.totalModules} completed</div>
                    </div>
                    <span class="topic-arrow">❯</span>
                `;
                button.addEventListener('click', () => startQuiz(topic));
                physicsTopicsGrid.appendChild(button);
            });
            feather.replace();
        }

        function startQuiz(topic) {
            currentTopic = topic;
            quizTitle.textContent = topic.name;
            showScreen('quiz-screen');
            resetQuizView();
            fetchQuizData(GOOGLE_SHEET_ID, topic);
        }

        function resetQuizView() {
            loadingContainer.style.display = 'block';
            errorContainer.style.display = 'none';
            questionsDisplay.innerHTML = '';
            navigationControls.style.display = 'none';
            allQuestions = [];
            currentQuestionIndex = 0;
        }

        // --- Functions (Data Fetching & Parsing) ---
        function fetchQuizData(sheetId, topic) {
            const queryParam = topic.gid ? `gid=${topic.gid}` : `sheet=${encodeURIComponent(topic.sheetName)}`;
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&${queryParam}`;
            
            fetch(url)
                .then(r => { if (!r.ok) throw new Error(`Network error: ${r.status}`); return r.text(); })
                .then(csv => {
                    allQuestions = parseCSVToQuestions(csv);
                    if (allQuestions.length > 0) {
                        navigationControls.style.display = 'flex';
                        showQuestion(currentQuestionIndex);
                    } else {
                        errorContainer.style.display = 'block';
                        errorContainer.textContent = 'No questions found in this topic.';
                    }
                    loadingContainer.style.display = 'none';
                })
                .catch(err => {
                    loadingContainer.style.display = 'none';
                    errorContainer.style.display = 'block';
                    errorContainer.textContent = `Error loading questions. Check Sheet ID, GID, and sharing settings.`;
                });
        }

        function parseCSVToQuestions(text) {
            const rows = text.trim().split(/\r?\n/).map(row => row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(f => f.trim().replace(/^"|"$/g, '')));
            if (rows.length < 2) return [];
            const headers = rows[0].map(h => h.trim().toLowerCase());
            const dataRows = rows.slice(1);

            const questionColIndex = headers.indexOf('question');
            const optionAIndex = headers.indexOf('a');
            const optionBIndex = headers.indexOf('b');
            const optionCIndex = headers.indexOf('c');
            const optionDIndex = headers.indexOf('d');
            const correctAnswerIndex = headers.indexOf('correct answer');
            const explanationIndex = headers.indexOf('explanation');

            if (questionColIndex === -1 || correctAnswerIndex === -1) return [];
            
            return dataRows.map((row, qIdx) => {
                const mainQuestionText = row[questionColIndex];
                if (!mainQuestionText) return null;

                const options = [
                    { label: 'A', text: row[optionAIndex] },
                    { label: 'B', text: row[optionBIndex] },
                    { label: 'C', text: row[optionCIndex] },
                    { label: 'D', text: row[optionDIndex] }
                ].filter(opt => opt.text);

                const correctAnsLabel = row[correctAnswerIndex]?.toUpperCase() || '';
                const explanation = row[explanationIndex] || '';
                const correctOption = options.find(opt => opt.label === correctAnsLabel);

                return {
                    id: `${currentTopic.gid}_q${qIdx}`,
                    question: mainQuestionText,
                    options: options,
                    correctAnswer: correctOption ? correctOption.text : 'N/A',
                    correctAnswerLabel: correctAnsLabel,
                    explanation: explanation
                };
            }).filter(Boolean);
        }

        // --- Functions (Quiz Rendering & Interaction) ---
        function showQuestion(index) {
            if (!allQuestions || allQuestions.length === 0) return;
            const q = allQuestions[index];
            
            const optionsHtml = q.options.map((option) => `
                <label>
                    <input type="radio" name="q${index}" value="${option.label}">
                    <span>${option.label}) ${option.text}</span>
                </label>
            `).join('');

            const isBookmarked = userBookmarks.has(q.id);
            const bookmarkClass = isBookmarked ? 'bookmarked' : '';

            questionsDisplay.innerHTML = `
                <div class="question-block" id="main-question-${index}">
                    <div class="question-header">
                        <div class="question-number">Question ${index + 1}</div>
                        <button class="bookmark-button ${bookmarkClass}" data-question-id="${q.id}" onclick="window.toggleBookmark('${q.id}', '${q.question.replace(/'/g, "\\'")}')" title="Bookmark Question">
                            <i data-feather="bookmark"></i>
                        </button>
                    </div>
                    <p class="main-question-text">${q.question}</p>
                    <div class="question-options">${optionsHtml}</div>
                    <div class="all-explanations" id="explanations-${index}">
                        <h3>Explanation</h3>
                        <p class="font-semibold">Correct Answer: ${q.correctAnswerLabel}) ${q.correctAnswer}</p>
                        <p>${q.explanation}</p>
                    </div>
                </div>`;
            
            updateNav(index);
            attachOptionListeners(index);
            feather.replace();
        }

        function attachOptionListeners(questionIndex) {
            const questionBlock = document.getElementById(`main-question-${questionIndex}`);
            const radioButtons = questionBlock.querySelectorAll(`input[name="q${questionIndex}"]`);
            
            radioButtons.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    evaluateAnswer(questionIndex, e.target.value);
                }, { once: true });
            });
        }

        function evaluateAnswer(qIndex, selectedLabel) {
            const q = allQuestions[qIndex];
            const isCorrect = selectedLabel === q.correctAnswerLabel;

            const questionBlock = document.getElementById(`main-question-${qIndex}`);
            const radioButtons = questionBlock.querySelectorAll(`input[name="q${qIndex}"]`);
            const explanationsContainer = questionBlock.querySelector('.all-explanations');

            radioButtons.forEach(radio => {
                radio.disabled = true;
                const labelElement = radio.closest('label');

                if (radio.value === q.correctAnswerLabel) {
                    labelElement.classList.add('selected-correct');
                }
                if (radio.value === selectedLabel && !isCorrect) {
                    labelElement.classList.add('selected-incorrect');
                } else if (radio.value !== selectedLabel && radio.value === q.correctAnswerLabel) {
                    labelElement.classList.add('correct-answer');
                }
            });

            if (explanationsContainer) {
                explanationsContainer.classList.add('visible');
            }
        }

        function updateNav(index) {
            questionCounter.textContent = `Question ${index + 1} of ${allQuestions.length}`;
            prevButton.disabled = index === 0;
            nextButton.disabled = index === allQuestions.length - 1;
        }

        // --- Event Listeners ---
        prevButton.addEventListener('click', () => showQuestion(--currentQuestionIndex));
        nextButton.addEventListener('click', () => showQuestion(++currentQuestionIndex));

    </script>
</body>
</html>
�
