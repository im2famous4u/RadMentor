<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RadMentor Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* Your existing CSS styles remain unchanged */
    body {
      font-family: 'Inter', sans-serif;
    }
    .sidebar-scroll {
      -ms-overflow-style: none; scrollbar-width: none;
    }
    .sidebar-scroll::-webkit-scrollbar {
      display: none;
    }
    .user-profile-icon {
        width: 40px; height: 40px; background-color: #6366f1; color: white;
        border-radius: 50%; display: flex; align-items: center;
        justify-content: center; font-weight: 600; cursor: pointer;
        user-select: none;
    }
    .user-dropdown {
        position: absolute; top: 55px; right: 0; background-color: white;
        border-radius: 0.75rem; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        z-index: 50; min-width: 180px; padding: 0.5rem 0; display: none;
        transition: opacity 0.2s ease-out, transform 0.2s ease-out;
    }
    .user-dropdown.show {
        display: block; opacity: 1; transform: translateY(0);
    }
    #contentFrame {
      width: 100%; height: 100%; border: none;
    }
  </style>
</head>
<body class="flex min-h-screen bg-gray-50 text-gray-800">

  <aside class="w-72 bg-white border-r border-gray-200 p-6 flex flex-col shadow-xl rounded-r-2xl overflow-y-auto sidebar-scroll">
    <div class="mb-10 flex items-center gap-3">
      <img src="https://placehold.co/40x40/6366f1/ffffff?text=RM" alt="RadMentor Logo" class="h-10 w-10 rounded-full shadow-md">
      <span class="text-2xl font-extrabold text-gray-900">RadMentor</span>
    </div>

    <div class="text-xs text-gray-500 uppercase font-bold tracking-wider mb-3">Exam Preparation</div>
    <nav class="flex flex-col gap-2 mb-8">
      <a href="dashboard.html" class="sidebar-link flex items-center px-4 py-2.5 rounded-xl text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700">Dashboard</a>
      <a href="frcr/index.html" class="sidebar-link flex items-center px-4 py-2.5 rounded-xl text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700">FRCR</a>
      </nav>

    <div class="text-xs text-gray-500 uppercase font-bold tracking-wider mb-3">My Account</div>
    <nav class="flex flex-col gap-2">
        <a href="my-profile.html" class="sidebar-link flex items-center px-4 py-2.5 rounded-xl text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-700">My Profile</a>
    </nav>
  </aside>

  <main class="flex-1 p-8 flex flex-col">
    <div class="flex items-center justify-end mb-8 relative">
      <div class="relative">
        <div id="userProfileIcon" class="user-profile-icon">
          <span id="userInitials">...</span>
        </div>
        <div id="userDropdown" class="user-dropdown">
          <a href="my-profile.html">Profile</a>
          <a href="#" id="logoutLink">Log out</a>
        </div>
      </div>
    </div>

    <iframe id="contentFrame" src="dashboard.html" title="Main Content"></iframe>

  </main>
  
  <script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // Your Firebase configuration object
    const firebaseConfig = {
      apiKey: "AIzaSyD-OTIwv6P88eT2PCPJXiHgZEDgFV8ZcSw",
      authDomain: "radiology-mcqs.firebaseapp.com",
      projectId: "radiology-mcqs",
      storageBucket: "radiology-mcqs.appspot.com",
      messagingSenderId: "862300415358",
      appId: "1:862300415358:web:097d5e413f388e30587f2f",
      measurementId: "G-0V1SD1H95V"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Wait for the document to be fully loaded before running scripts
    document.addEventListener('DOMContentLoaded', () => {
        const userInitialsEl = document.getElementById('userInitials');
        const logoutLink = document.getElementById('logoutLink');
        const userProfileIcon = document.getElementById('userProfileIcon');
        const userDropdown = document.getElementById('userDropdown');

        // --- This is the Authentication Guard ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in.
                console.log("Dashboard: User is logged in:", user.uid);
                
                // Fetch the user's name from Firestore
                const userDocRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists() && docSnap.data().profileComplete) {
                    const userData = docSnap.data();
                    const name = userData.name;
                    
                    // Display user's initials
                    if (name && userInitialsEl) {
                        const initials = name.split(' ').map(n => n[0]).join('').toUpperCase();
                        userInitialsEl.textContent = initials;
                    }
                } else {
                    // If profile is not complete, redirect to the main page to force completion.
                    console.log("Dashboard: User profile not complete. Redirecting.");
                    window.location.replace('/index.html');
                }
            } else {
                // User is not signed in. Redirect them to the main page.
                console.log("Dashboard: User not logged in. Redirecting.");
                window.location.replace('/index.html');
            }
        });

        // --- Logout Button Logic ---
        if (logoutLink) {
            logoutLink.addEventListener('click', (event) => {
                event.preventDefault(); // Prevent default link behavior
                signOut(auth).catch((error) => console.error('Sign out error', error));
                // The onAuthStateChanged listener will automatically redirect after successful sign out.
            });
        }
        
        // --- Dropdown Menu Logic ---
        if(userProfileIcon) {
            userProfileIcon.addEventListener('click', () => {
                userDropdown.classList.toggle('show');
            });
        }

        // Close dropdown if clicked outside
        window.addEventListener('click', function(e) {
          if (userProfileIcon && !userProfileIcon.contains(e.target) && userDropdown && !userDropdown.contains(e.target)) {
            userDropdown.classList.remove('show');
          }
        });
    });
  </script>

</body>
</html>
