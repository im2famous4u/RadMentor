<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RadMentor Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-scroll::-webkit-scrollbar { display: none; }
        .sidebar-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        .sidebar-link.active {
            background-color: #eff6ff; /* blue-100 */
            color: #3b82f6; /* blue-600 */
            font-weight: 600; /* semi-bold */
        }
        .sidebar-link.active svg { color: #3b82f6; }
        
        /* Dropdown styles */
        .user-profile-icon {
            width: 40px; height: 40px; background-color: #4f46e5; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-weight: 600; cursor: pointer;
            user-select: none; transition: transform 0.2s ease-in-out; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .user-profile-icon:hover { transform: scale(1.05); }

        .dropdown-menu {
            position: absolute; top: 55px; right: 0; background-color: white; border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); z-index: 50; min-width: 180px; padding: 0.5rem 0;
            display: none; opacity: 0; transform: translateY(-10px);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
        .dropdown-menu.show { display: block; opacity: 1; transform: translateY(0); }
        .dropdown-menu a {
            display: flex; align-items: center; padding: 0.75rem 1.25rem; font-size: 0.9rem;
            color: #4a5568; transition: background-color 0.2s, color 0.2s;
        }
        .dropdown-menu a:hover { background-color: #f3f4f6; color: #3b82f6; }
        .dropdown-menu a:last-child { border-top: 1px solid #e5e7eb; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="auth-loader" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-lg font-medium text-gray-600">Authenticating...</p>
    </div>

    <div id="dashboard-layout" class="flex min-h-screen w-full hidden">
        <aside class="w-64 bg-white border-r border-gray-200 p-5 flex-col shadow-lg hidden md:flex">
            <div class="mb-8 flex items-center gap-3">
                <img src="https://placehold.co/40x40/6366f1/ffffff?text=RM" alt="RadMentor Logo" class="h-10 w-10 rounded-full shadow-md">
                <span class="text-2xl font-extrabold text-gray-900">RadMentor</span>
            </div>

            <div class="text-xs text-gray-500 uppercase font-bold tracking-wider mb-3">Menu</div>
            <nav id="sidebar-nav" class="flex flex-col gap-2">
                <a href="dashboard-home.html" class="sidebar-link flex items-center px-4 py-2.5 rounded-lg text-sm" data-section="dashboard">
                    <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                    Dashboard
                </a>
                 <a href="frcr/index.html" class="sidebar-link flex items-center px-4 py-2.5 rounded-lg text-sm" data-section="frcr">
                    <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                    FRCR
                </a>
                <a href="radscribe-ai.html" class="sidebar-link flex items-center px-4 py-2.5 rounded-lg text-sm" data-section="radscribe-ai">
                    <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                    RadScribe AI
                </a>
                <a href="my-profile.html" class="sidebar-link flex items-center px-4 py-2.5 rounded-lg text-sm" data-section="my-profile">
                    <svg class="h-5 w-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    My Profile
                </a>
            </nav>
        </aside>

        <main class="flex-1 flex flex-col">
            <header class="bg-white border-b border-gray-200 p-4 flex items-center justify-between shadow-sm">
                <h1 id="header-title" class="text-xl font-bold text-gray-800">Dashboard</h1>
                <div class="relative">
                    <div id="user-profile-icon" class="user-profile-icon">
                        <span id="user-initials"></span>
                    </div>
                    <div id="user-dropdown" class="dropdown-menu">
                        <div class="px-4 py-2 border-b">
                            <p class="text-sm font-semibold text-gray-800" id="user-dropdown-name"></p>
                            <p class="text-xs text-gray-500" id="user-dropdown-email"></p>
                        </div>
                        <a href="#" id="logout-link">
                            <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                            Log out
                        </a>
                    </div>
                </div>
            </header>

            <div class="flex-1 p-6">
                <iframe id="content-frame" src="dashboard-home.html" class="w-full h-full bg-white rounded-xl shadow-md"></iframe>
            </div>
        </main>
    </div>

    <script type="module">
        // --- FIREBASE SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyD-OTIwv6P88eT2PCPJXiHgZEDgFV8ZcSw",
          authDomain: "radiology-mcqs.firebaseapp.com",
          projectId: "radiology-mcqs",
          storageBucket: "radiology-mcqs.appspot.com",
          messagingSenderId: "862300415358",
          appId: "1:862300415358:web:097d5e413f388e30587f2f",
          measurementId: "G-0V1SD1H95V"
        };

        // --- INITIALIZE FIREBASE & SERVICES ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM ELEMENT REFERENCES ---
        const authLoader = document.getElementById('auth-loader');
        const dashboardLayout = document.getElementById('dashboard-layout');
        const userInitials = document.getElementById('user-initials');
        const userDropdownName = document.getElementById('user-dropdown-name');
        const userDropdownEmail = document.getElementById('user-dropdown-email');
        const userProfileIcon = document.getElementById('user-profile-icon');
        const userDropdown = document.getElementById('user-dropdown');
        const logoutLink = document.getElementById('logout-link');
        const sidebarNav = document.getElementById('sidebar-nav');
        const contentFrame = document.getElementById('content-frame');
        const headerTitle = document.getElementById('header-title');

        // --- AUTHENTICATION GUARD ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is logged in, fetch their profile
                const userDocRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists() && docSnap.data().profileComplete) {
                    // Profile exists and is complete, show the dashboard
                    const userData = docSnap.data();
                    displayUserData(userData);
                    authLoader.style.display = 'none';
                    dashboardLayout.classList.remove('hidden');
                    dashboardLayout.classList.add('flex');
                } else {
                    // User exists but profile is incomplete, redirect to landing page to force completion
                    alert("Please complete your profile before accessing the dashboard.");
                    window.location.href = '../index.html';
                }
            } else {
                // User is not logged in, redirect to the landing page
                console.log("No user logged in. Redirecting...");
                window.location.href = '../index.html?reason=unauthenticated';
            }
        });

        // --- UI FUNCTIONS ---
        function displayUserData(userData) {
            const name = userData.name || 'New User';
            const email = userData.email || '';
            const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

            userInitials.textContent = initials;
            userDropdownName.textContent = name;
            userDropdownEmail.textContent = email;
        }

        function setActiveLink(targetHref) {
            document.querySelectorAll('#sidebar-nav .sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === targetHref) {
                    link.classList.add('active');
                    headerTitle.textContent = link.textContent.trim();
                }
            });
        }
        
        // --- EVENT LISTENERS ---
        // User Dropdown
        userProfileIcon.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('show');
        });

        // Sidebar Navigation
        sidebarNav.addEventListener('click', (e) => {
            e.preventDefault();
            const link = e.target.closest('.sidebar-link');
            if (link) {
                const targetPage = link.getAttribute('href');
                if (targetPage && contentFrame.getAttribute('src') !== targetPage) {
                    contentFrame.src = targetPage;
                    setActiveLink(targetPage);
                }
            }
        });

        // Logout
        logoutLink.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await signOut(auth);
                // onAuthStateChanged will handle the redirect
            } catch (error) {
                console.error("Error signing out: ", error);
                alert("Could not log out. Please try again.");
            }
        });

        // Close dropdown when clicking outside
        window.addEventListener('click', () => {
            if (userDropdown.classList.contains('show')) {
                userDropdown.classList.remove('show');
            }
        });
        
        // Initial setup
        setActiveLink('dashboard-home.html');

    </script>

</body>
</html>
