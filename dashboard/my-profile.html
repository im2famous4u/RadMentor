<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Profile - RadMentor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: transparent; }
    .glass-card {
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      border-radius: 1.5rem;
      padding: 2.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.07);
    }
    .gradient-bg { background: linear-gradient(to right, #6366f1, #8b5cf6); }
    .form-input { width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; }
    .form-input:focus { outline: none; box-shadow: 0 0 0 2px #a5b4fc; border-color: #6366f1; }
    .form-label { display: block; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
  </style>
</head>
<body class="p-4">
  <div id="loading-indicator" class="text-center py-10">
    <p class="text-lg font-semibold text-gray-700">Loading Your Profile...</p>
  </div>
  <div id="profile-container" class="w-full max-w-3xl mx-auto glass-card hidden">
    <h2 class="text-3xl font-bold text-gray-800 mb-8">My Profile Settings</h2>
    <form id="profileForm" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div><label for="userName" class="form-label">Full Name</label><input type="text" id="userName" class="form-input" placeholder="Your full name"></div>
        <div><label for="userEmail" class="form-label">Email</label><input type="email" id="userEmail" class="form-input bg-gray-100 cursor-not-allowed" readonly></div>
        <div><label for="userDob" class="form-label">Date of Birth</label><input type="date" id="userDob" class="form-input"></div>
        <div><label for="userSex" class="form-label">Sex</label><select id="userSex" class="form-input"><option value="" disabled selected>Select Sex</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option></select></div>
        <div><label for="userPosition" class="form-label">Position</label><select id="userPosition" class="form-input"><option value="" disabled selected>Select Position</option><option value="Intern">Intern</option><option value="Junior Resident">Junior Resident</option><option value="Senior Resident">Senior Resident</option><option value="Consultant">Consultant</option></select></div>
        <div><label for="userExam" class="form-label">Exam Pursuing</label><select id="userExam" class="form-input"><option value="" disabled selected>Select Exam</option><option value="Final year exam">Final year exam</option><option value="DNB">DNB</option><option value="FRCR">FRCR</option></select></div>
        <div class="md:col-span-2"><label for="userCollege" class="form-label">Medical College</label><input type="text" id="userCollege" class="form-input" placeholder="Your medical college"></div>
      </div>
      <button type="submit" id="saveButton" class="w-full gradient-bg text-white font-semibold py-3 rounded-xl shadow-lg hover:shadow-xl transition-all">Save Changes</button>
    </form>
  </div>

  <script type="module">
    // --- THIS IS THE FIX: Added initializeApp to connect this page to Firebase ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // Your Firebase project configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD-OTIwv6P88eT2PCPJXiHgZEDgFV8ZcSw",
      authDomain: "radiology-mcqs.firebaseapp.com",
      projectId: "radiology-mcqs",
      storageBucket: "radiology-mcqs.appspot.com",
      messagingSenderId: "862300415358",
      appId: "1:862300415358:web:097d5e413f388e30587f2f",
      measurementId: "G-0V1SD1H95V"
    };

    // Initialize Firebase within this page
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    // --- END OF FIX ---

    const loadingIndicator = document.getElementById('loading-indicator');
    const profileContainer = document.getElementById('profile-container');
    const profileForm = document.getElementById('profileForm');
    const saveButton = document.getElementById('saveButton');
    
    const inputs = {
        name: document.getElementById('userName'),
        email: document.getElementById('userEmail'),
        dob: document.getElementById('userDob'),
        sex: document.getElementById('userSex'),
        position: document.getElementById('userPosition'),
        exam_pursuing: document.getElementById('userExam'),
        college: document.getElementById('userCollege')
    };

    onAuthStateChanged(auth, (user) => {
      if (user) {
        inputs.email.value = user.email;
        loadUserProfile(user.uid);
      } else {
        window.top.location.href = '../index.html';
      }
    });

    async function loadUserProfile(uid) {
      try {
        const docRef = doc(db, "users", uid);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const data = docSnap.data();
          for (const key in inputs) {
            if (inputs.hasOwnProperty(key) && data[key]) {
              inputs[key].value = data[key];
            }
          }
        } else {
          console.warn("No profile document found for this user!");
        }
      } catch (error) {
        console.error("Error loading user profile:", error);
      } finally {
        loadingIndicator.classList.add('hidden');
        profileContainer.classList.remove('hidden');
      }
    }

    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return;

      saveButton.disabled = true;
      saveButton.textContent = 'Saving...';

      const dataToUpdate = {
        name: inputs.name.value,
        dob: inputs.dob.value,
        sex: inputs.sex.value,
        position: inputs.position.value,
        exam_pursuing: inputs.exam_pursuing.value,
        college: inputs.college.value
      };

      try {
        await updateDoc(doc(db, "users", user.uid), dataToUpdate);
        if (window.parent.showMessage) {
            window.parent.showMessage('Profile updated successfully!', 'success');
            window.parent.currentUserName = dataToUpdate.name;
            window.parent.updateInitials();
        }
      } catch (error) {
        if (window.parent.showMessage) window.parent.showMessage('Failed to update.', 'error');
      } finally {
        saveButton.disabled = false;
        saveButton.textContent = 'Save Changes';
      }
    });
  </script>
</body>
</html>
