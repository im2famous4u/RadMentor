<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced DICOM Viewer</title>

    <script src="https://unpkg.com/cornerstone-core@2.6.1/dist/cornerstone.js"></script>
    <script src="https://unpkg.com/cornerstone-tools@5.1.0/dist/cornerstoneTools.js"></script>
    <script src="https://unpkg.com/dicom-parser@1.8.21/dist/dicomParser.js"></script>
    <script src="https://unpkg.com/cornerstone-wado-image-loader@4.9.0/dist/cornerstoneWADOImageLoader.js"></script>

    <style>
        :root {
            --primary-bg: #1a1a1a;
            --secondary-bg: #2c2c2c;
            --text-color: #e0e0e0;
            --accent-color: #00bcd4;
            --border-color: #444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            width: 100%;
            height: calc(100% - 50px); /* Adjust for header height */
            gap: 20px;
            padding: 20px;
            box-sizing: border-box;
        }

        h1 {
            width: 100%;
            text-align: center;
            color: var(--accent-color);
            margin: 10px 0;
            font-weight: 300;
        }

        .viewer-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #dicomImage {
            width: 100%;
            max-width: 512px;
            height: 512px;
            background-color: black;
            position: relative;
            color: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        #image-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            color: var(--accent-color);
            font-size: 14px;
            text-shadow: 1px 1px 2px black;
            pointer-events: none; /* Allows mouse events to pass through */
        }

        .controls-panel {
            width: 350px;
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-group {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        .control-group:last-child {
            border-bottom: none;
        }

        .control-group h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text-color);
        }

        .tool-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .tool-buttons button, #resetBtn {
            background-color: #3e3e3e;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }

        .tool-buttons button:hover, #resetBtn:hover {
            background-color: #555;
        }

        .tool-buttons button.active {
            background-color: var(--accent-color);
            color: var(--primary-bg);
            font-weight: bold;
        }
        
        #resetBtn {
            width: 100%;
            background-color: #c84040;
        }
        #resetBtn:hover {
             background-color: #e06060;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input[type=range] {
            width: 100%;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>Shoulder MRI Viewer Enhanced</h1>

    <div class="main-container">
        <div class="viewer-wrapper">
            <div id="dicomImage">
                <div id="image-overlay">
                    <div id="slice-info">Slice: -/-</div>
                    <div id="ww-wc-info">WW/WC: -/-</div>
                </div>
            </div>
        </div>

        <div class="controls-panel">
            <div class="control-group">
                <h3>Slice Navigation</h3>
                <input type="range" id="sliceSlider" min="0" max="279" value="0">
                <p style="text-align:center; font-size: 12px; margin-top: 5px;">Use slider, mouse wheel, or arrow keys</p>
            </div>
            
            <div class="control-group">
                <h3>Tools</h3>
                <div class="tool-buttons">
                    <button id="scrollBtn" class="active">Scroll</button>
                    <button id="wwwcBtn">Windowing</button>
                    <button id="panBtn">Pan</button>
                    <button id="zoomBtn">Zoom</button>
                </div>
            </div>

            <div class="control-group">
                <h3>Windowing</h3>
                <label for="wwSlider">Window Width: <span id="wwValue">400</span></label>
                <input type="range" id="wwSlider" min="1" max="5000" value="400">
                <label for="wcSlider">Window Center: <span id="wcValue">200</span></label>
                <input type="range" id="wcSlider" min="-2000" max="2000" value="200">
            </div>

            <div class="control-group">
                <h3>Actions</h3>
                 <button id="resetBtn">Reset View</button>
            </div>
        </div>
    </div>

    <script>
        // --- Cornerstone Configuration ---
        cornerstoneWADOImageLoader.external.cornerstone = cornerstone;
        cornerstoneWADOImageLoader.external.dicomParser = dicomParser;
        cornerstoneWADOImageLoader.webWorkerManager.initialize({
            webWorkerPath: 'https://unpkg.com/cornerstone-wado-image-loader/dist/cornerstoneWADOImageLoaderWebWorker.min.js',
            taskConfiguration: {
                decodeTask: {
                    codecsPath: 'https://unpkg.com/cornerstone-wado-image-loader/dist/cornerstoneWADOImageLoaderCodecs.min.js'
                }
            }
        });

        // --- DOM Elements ---
        const element = document.getElementById('dicomImage');
        const sliceSlider = document.getElementById('sliceSlider');
        const sliceInfo = document.getElementById('slice-info');
        const wwWcInfo = document.getElementById('ww-wc-info');
        const wwSlider = document.getElementById('wwSlider');
        const wcSlider = document.getElementById('wcSlider');
        const wwValue = document.getElementById('wwValue');
        const wcValue = document.getElementById('wcValue');
        const toolButtons = document.querySelectorAll('.tool-buttons button');
        const resetBtn = document.getElementById('resetBtn');

        // --- Image Loading ---
        const baseUrl = "https://raw.githubusercontent.com/im2famous4u/RadMentor/main/anatomy/mri-anatomy/test_shoulder/shoulder-dicom/";
        const numImages = 280;
        const imageIds = Array.from({ length: numImages }, (_, i) => {
            const num = String(i + 1).padStart(4, '0');
            return `wadouri:${baseUrl}IMG${num}.dcm`;
        });
        
        const stack = {
            currentImageIdIndex: 0,
            imageIds,
        };

        // --- Cornerstone Initialization ---
        cornerstone.enable(element);

        // --- Cornerstone Tools Initialization ---
        cornerstoneTools.init({ showSVGCursors: true });

        // Add tools
        const tools = [
            cornerstoneTools.StackScrollTool,
            cornerstoneTools.StackScrollMouseWheelTool,
            cornerstoneTools.WwwcTool,
            cornerstoneTools.PanTool,
            cornerstoneTools.ZoomTool,
            cornerstoneTools.WwwcTouchTool,
            cornerstoneTools.PanTouchTool,
            cornerstoneTools.ZoomTouchTool,
        ];
        tools.forEach(tool => cornerstoneTools.addTool(tool));

        // Set tool state
        cornerstoneTools.addStackStateManager(element, ['stack']);
        cornerstoneTools.setStack(element, stack);
        
        // --- Functions ---
        function setActiveTool(toolName, mouseButton) {
            cornerstoneTools.setToolActive(toolName, { mouseButtonMask: mouseButton });
            toolButtons.forEach(btn => {
                btn.classList.toggle('active', btn.id.toLowerCase().startsWith(toolName.toLowerCase().substring(0,4)));
            });
        }
        
        function updateViewport() {
            const viewport = cornerstone.getViewport(element);
            if (!viewport) return;
            
            viewport.voi.windowWidth = parseFloat(wwSlider.value);
            viewport.voi.windowCenter = parseFloat(wcSlider.value);
            cornerstone.setViewport(element, viewport);

            wwValue.textContent = viewport.voi.windowWidth.toFixed(0);
            wcValue.textContent = viewport.voi.windowCenter.toFixed(0);
        }

        function updateUI(e) {
            const viewport = e.detail.viewport;
            const imageIndex = stack.imageIds.indexOf(e.detail.image.imageId);

            // Update slice info
            sliceInfo.textContent = `Slice: ${imageIndex + 1} / ${numImages}`;
            sliceSlider.value = imageIndex;

            // Update WW/WC info
            wwWcInfo.textContent = `WW/WC: ${viewport.voi.windowWidth.toFixed(0)} / ${viewport.voi.windowCenter.toFixed(0)}`;
            wwSlider.value = viewport.voi.windowWidth;
            wcSlider.value = viewport.voi.windowCenter;
            wwValue.textContent = viewport.voi.windowWidth.toFixed(0);
            wcValue.textContent = viewport.voi.windowCenter.toFixed(0);
        }

        // --- Event Listeners ---
        sliceSlider.addEventListener('input', (e) => {
            const index = parseInt(e.target.value, 10);
            cornerstoneTools.scrollToIndex(element, index);
        });

        wwSlider.addEventListener('input', updateViewport);
        wcSlider.addEventListener('input', updateViewport);

        document.addEventListener('keydown', (e) => {
            let currentIndex = stack.currentImageIdIndex;
            if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') {
                if (currentIndex > 0) cornerstoneTools.scrollToIndex(element, currentIndex - 1);
            } else if (e.key === 'ArrowDown' || e.key === 'ArrowRight') {
                if (currentIndex < numImages - 1) cornerstoneTools.scrollToIndex(element, currentIndex + 1);
            }
        });

        toolButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.target.id;
                if (id === 'scrollBtn') {
                    // Deactivate others, scroll is handled by mouse wheel tool
                    setActiveTool('StackScrollMouseWheel', 1); // Activate scroll
                    setActiveTool('Wwwc', 0); // Deactivate other tools
                    setActiveTool('Pan', 0);
                    setActiveTool('Zoom', 0);
                } else if (id === 'wwwcBtn') {
                    setActiveTool('Wwwc', 1);
                } else if (id === 'panBtn') {
                    setActiveTool('Pan', 1);
                } else if (id === 'zoomBtn') {
                    setActiveTool('Zoom', 1);
                }
            });
        });

        resetBtn.addEventListener('click', () => cornerstone.reset(element));

        element.addEventListener('cornerstoneimagerendered', updateUI);


        // --- Initial Load ---
        cornerstone.loadAndCacheImage(imageIds[0]).then(image => {
            cornerstone.displayImage(element, image);
            setActiveTool('StackScrollMouseWheel', 1); // Mouse Wheel for scrolling
            setActiveTool('Pan', 2); // Middle mouse for panning
            setActiveTool('Zoom', 4); // Right mouse for zooming
        }).catch(err => {
            console.error("Error loading initial image:", err);
            sliceInfo.textContent = "Error loading image.";
        });

    </script>
</body>
</html>
