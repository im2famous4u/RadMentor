<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DICOM MPR Viewer</title>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/dwv@0.31.0/dist/dwv.min.css">
    <script type="text/javascript" src="https://unpkg.com/dwv@0.31.0/dist/dwv.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        .toolbar {
            padding: 10px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .toolbar h1 {
            margin: 0;
            font-size: 1.5em;
            margin-right: 20px;
        }
        .toolbar button {
            margin-right: 10px;
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .toolbar button:hover {
            background-color: #2980b9;
        }
        .toolbar button.active {
            background-color: #e74c3c;
        }
        .viewer-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .viewport {
            flex: 1;
            position: relative;
            border: 1px solid #bdc3c7;
            margin: 5px;
            background-color: #34495e;
            overflow: hidden;
        }
        .viewport-title {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            z-index: 10;
            font-weight: bold;
        }
        .layerContainer {
            position: relative;
            width: 100%;
            height: 100%;
        }
        .imageLayer {
            position: absolute;
            left: 0px;
            top: 0px;
        }
        .controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: center;
            z-index: 10;
        }
        .controls button {
            margin: 0 5px;
            padding: 5px 10px;
            background-color: rgba(52, 73, 94, 0.8);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .controls button:hover {
            background-color: rgba(44, 62, 80, 0.9);
        }
        .status {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            z-index: 10;
            font-size: 0.9em;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2em;
            z-index: 20;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="toolbar">
            <h1>DICOM MPR Viewer</h1>
            <button id="loadSeries">Load Series</button>
            <button id="scrollTool" class="active">Scroll</button>
            <button id="windowLevelTool">Window/Level</button>
            <button id="zoomTool">Zoom</button>
            <button id="resetView">Reset View</button>
        </div>
        <div class="viewer-container">
            <div class="viewport" id="axial">
                <div class="viewport-title">Axial</div>
                <div class="layerContainer">
                    <canvas class="imageLayer"></canvas>
                </div>
                <div class="controls">
                    <button id="prevAxial">Previous</button>
                    <button id="nextAxial">Next</button>
                </div>
                <div class="status" id="axialStatus">Ready</div>
                <div class="loading" id="axialLoading" style="display: none;">Loading...</div>
            </div>
            <div class="viewport" id="sagittal">
                <div class="viewport-title">Sagittal</div>
                <div class="layerContainer">
                    <canvas class="imageLayer"></canvas>
                </div>
                <div class="controls">
                    <button id="prevSagittal">Previous</button>
                    <button id="nextSagittal">Next</button>
                </div>
                <div class="status" id="sagittalStatus">Ready</div>
                <div class="loading" id="sagittalLoading" style="display: none;">Loading...</div>
            </div>
            <div class="viewport" id="coronal">
                <div class="viewport-title">Coronal</div>
                <div class="layerContainer">
                    <canvas class="imageLayer"></canvas>
                </div>
                <div class="controls">
                    <button id="prevCoronal">Previous</button>
                    <button id="nextCoronal">Next</button>
                </div>
                <div class="status" id="coronalStatus">Ready</div>
                <div class="loading" id="coronalLoading" style="display: none;">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration for DWV
        const baseConfig = {
            "tools": ["Scroll", "WindowLevel", "ZoomAndPan"],
            "loaders": ["File"],
            "skipLoadUrl": true
        };

        // Initialize DWV for each viewport
        const viewports = ['axial', 'sagittal', 'coronal'];
        const apps = {};
        const currentSlices = {
            'axial': 0,
            'sagittal': 0,
            'coronal': 0
        };
        const totalSlices = 280; // Total number of DICOM files (as per your data)

        viewports.forEach(viewportId => {
            const config = {
                ...baseConfig,
                "containerDivId": viewportId,
                "defaultCharacterSet": 'ISO_IR 100'
            };
            const app = new dwv.App(config);
            app.init();
            apps[viewportId] = app;
            
            // Add event listeners for slice navigation
            document.getElementById(`prev${viewportId.charAt(0).toUpperCase() + viewportId.slice(1)}`).addEventListener('click', () => {
                if (currentSlices[viewportId] > 0) {
                    currentSlices[viewportId]--;
                    updateSlice(viewportId);
                }
            });
            
            document.getElementById(`next${viewportId.charAt(0).toUpperCase() + viewportId.slice(1)}`).addEventListener('click', () => {
                if (currentSlices[viewportId] < totalSlices - 1) {
                    currentSlices[viewportId]++;
                    updateSlice(viewportId);
                }
            });
        });

        // Load the DICOM files
        // CORRECTED BUCKET URL AND FILE NAMING CONVENTION
        const bucketUrl = 'https://radmentor.s3.eu-north-1.amazonaws.com/';
        const fileUrls = [];

        for (let i = 1; i <= totalSlices; i++) {
            const num = i.toString().padStart(5, '0'); // Pad with 5 zeros for the second part (e.g., 00001)
            fileUrls.push(`${bucketUrl}IMG-0001-${num}.dcm`); // Construct the full filename: IMG-0001-00001.dcm
        }

        // Load the series into each viewport
        document.getElementById('loadSeries').addEventListener('click', () => {
            viewports.forEach(viewportId => {
                const app = apps[viewportId];
                // Show loading indicator
                document.getElementById(`${viewportId}Loading`).style.display = 'block';
                document.getElementById(`${viewportId}Status`).textContent = 'Loading...';
                
                // Clear previous data
                app.resetDisplay();
                
                // Load files
                const promises = fileUrls.map(url => {
                    return fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! Status: ${response.status} for ${url}`);
                            }
                            return response.blob();
                        })
                        .then(blob => {
                            const file = new File([blob], url.split('/').pop());
                            return app.loadFiles([file]);
                        });
                });
                
                Promise.all(promises)
                    .then(() => {
                        // Hide loading indicator
                        document.getElementById(`${viewportId}Loading`).style.display = 'none';
                        document.getElementById(`${viewportId}Status`).textContent = `Slice 1/${totalSlices}`;
                        currentSlices[viewportId] = 0;
                    })
                    .catch(error => {
                        console.error('Error loading files:', error);
                        document.getElementById(`${viewportId}Loading`).style.display = 'none';
                        document.getElementById(`${viewportId}Status`).textContent = 'Error loading files (check console)';
                    });
            });
        });

        // Update the current slice
        function updateSlice(viewportId) {
            const app = apps[viewportId];
            const sliceIndex = currentSlices[viewportId];
            app.getViewController().setCurrentPosition({ sliceIndex });
            document.getElementById(`${viewportId}Status`).textContent = `Slice ${sliceIndex + 1}/${totalSlices}`;
        }

        // Tool selection
        document.getElementById('scrollTool').addEventListener('click', () => {
            setToolForAllViewports('Scroll');
            setActiveButton('scrollTool');
        });
        document.getElementById('windowLevelTool').addEventListener('click', () => {
            setToolForAllViewports('WindowLevel');
            setActiveButton('windowLevelTool');
        });
        document.getElementById('zoomTool').addEventListener('click', () => {
            setToolForAllViewports('ZoomAndPan');
            setActiveButton('zoomTool');
        });
        document.getElementById('resetView').addEventListener('click', () => {
            viewports.forEach(viewportId => {
                apps[viewportId].resetDisplay();
            });
        });

        function setToolForAllViewports(tool) {
            viewports.forEach(viewportId => {
                apps[viewportId].setTool(tool);
            });
        }

        function setActiveButton(buttonId) {
            document.querySelectorAll('.toolbar button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(buttonId).classList.add('active');
        }

        // Set initial tool
        setToolForAllViewports('Scroll');
    </script>
</body>
</html>
