<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FRCR Part 1 - RadMentor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .glass-card { background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-radius: 1.5rem; padding: 2rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid rgba(255, 255, 255, 0.3); }
    .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 50; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
    .modal-backdrop.active { opacity: 1; visibility: visible; }
    .modal-content { transform: scale(0.95); transition: transform 0.3s ease; }
    .modal-backdrop.active .modal-content { transform: scale(1); }
  </style>
</head>
<body class="bg-gray-100">

  <div id="frcr-content" class="w-full h-full p-4 md:p-8">
    <div class="glass-card max-w-4xl mx-auto">
      <div class="flex justify-between items-start mb-6">
        <div>
            <h2 class="text-3xl font-bold text-gray-800">FRCR Exam Preparation</h2>
            <p class="text-lg text-gray-600 mt-2">Welcome! Select a module to view your history or start a new test.</p>
        </div>
        <div id="auth-status" class="text-right">
            </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-blue-50/50 p-6 rounded-2xl border border-blue-100">
          <h3 class="text-xl font-semibold text-blue-800 mb-3">Part 1 - Physics & Anatomy</h3>
          <p class="text-base text-blue-700 mb-4">Detailed modules and question banks for FRCR Part 1.</p>
          <div class="flex flex-wrap gap-3">
            <button onclick="checkTestHistory('anatomy_part1')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded-lg shadow-md hover:shadow-lg transition-all">Anatomy</button>
            <button onclick="checkTestHistory('physics_part1')" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-5 py-2 rounded-lg shadow-md hover:shadow-lg transition-all">Physics</button>
          </div>
        </div>
        <div class="bg-green-50/50 p-6 rounded-2xl border border-green-100">
          <h3 class="text-xl font-semibold text-green-800 mb-3">Part 2 - Modules</h3>
          <p class="text-base text-green-700 mb-4">Specialty-specific modules for FRCR 2A & 2B.</p>
          <div class="flex flex-wrap gap-3">
            <button onclick="checkTestHistory('part2a')" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-2 rounded-lg shadow-md hover:shadow-lg transition-all">Part 2A</button>
            <button onclick="checkTestHistory('part2b')" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-5 py-2 rounded-lg shadow-md hover:shadow-lg transition-all">Part 2B</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="history-modal" class="modal-backdrop">
    <div class="modal-content bg-white w-11/12 max-w-lg mx-auto rounded-2xl shadow-xl p-6 md:p-8">
      <div class="flex justify-between items-center mb-4">
        <h3 id="modal-title" class="text-2xl font-bold text-gray-800">Test History</h3>
        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
      </div>
      <div id="modal-body" class="max-h-80 overflow-y-auto"></div>
      <div class="mt-6 flex justify-end gap-4">
        <button onclick="closeModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Close</button>
        <button onclick="startNewTest()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">Start New Test</button>
      </div>
    </div>
  </div>

  <script type="module">
    // --- Firebase SDK Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // --- Firebase Configuration (Same as your main index.html) ---
    const firebaseConfig = {
      apiKey: "AIzaSyD-OTIwv6P88eT2PCPJXiHgZEDgFV8ZcSw",
      authDomain: "radiology-mcqs.firebaseapp.com",
      projectId: "radiology-mcqs",
      storageBucket: "radiology-mcqs.appspot.com",
      messagingSenderId: "862300415358",
      appId: "1:862300415358:web:097d5e413f388e30587f2f",
      measurementId: "G-0V1SD1H95V"
    };

    // --- App State ---
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let currentUserId = null;
    let currentTestId = null;

    // --- DOM Elements ---
    const authStatusEl = document.getElementById('auth-status');
    const modal = document.getElementById('history-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');

    // --- Authentication Check ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is signed in from the main page.
        currentUserId = user.uid;
        console.log("User is signed in with UID:", currentUserId);
        authStatusEl.innerHTML = `<p class="text-sm text-green-600">Logged In</p>`;
      } else {
        // User is not signed in.
        console.log("No user signed in.");
        authStatusEl.innerHTML = `<p class="text-sm text-red-500">Not Logged In</p>`;
        // Redirect them back to the main page to log in after a short delay
        setTimeout(() => {
          // You would replace '../index.html' with the actual URL of your main page
          window.location.href = '../index.html'; 
        }, 2000);
      }
    });

    // --- Modal Logic ---
    window.openModal = (title) => {
        modalTitle.textContent = title;
        modal.classList.add('active');
    };
    window.closeModal = () => {
        modal.classList.remove('active');
    };
    
    // --- Test History Logic (Updated to use correct Firestore path) ---
    window.checkTestHistory = async (testId) => {
      if (!currentUserId) {
        alert("You must be logged in to view history. Redirecting to login page...");
        window.location.href = '../index.html';
        return;
      }
      
      currentTestId = testId;
      const testName = testId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      openModal(`${testName} - History`);
      modalBody.innerHTML = `<p class="text-gray-500">Fetching history...</p>`;

      try {
        // IMPORTANT: Using the correct path 'users/UID/testAttempts'
        const attemptsCollection = collection(db, "users", currentUserId, "testAttempts");
        const q = query(attemptsCollection, where("testModule", "==", testId));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
          modalBody.innerHTML = `<p class="text-gray-600">You haven't attempted this test before.</p>`;
        } else {
          let historyHtml = '<ul class="space-y-3">';
          querySnapshot.forEach(doc => {
            const data = doc.data();
            const score = data.score || 'N/A';
            const total = data.total || 'N/A';
            const date = data.timestamp?.toDate().toLocaleString() || 'Unknown Date';
            historyHtml += `
              <li class="bg-gray-50 p-4 rounded-lg flex justify-between items-center">
                <div>
                  <p class="font-semibold text-gray-700">Score: ${score} / ${total}</p>
                  <p class="text-sm text-gray-500">${date}</p>
                </div>
                <span class="text-lg font-bold text-indigo-600">${Math.round((score/total)*100)}%</span>
              </li>
            `;
          });
          historyHtml += '</ul>';
          modalBody.innerHTML = historyHtml;
        }
      } catch (error) {
        console.error("Error fetching test history:", error);
        modalBody.innerHTML = `<p class="text-red-500">Could not load history.</p>`;
      }
    };
    
    // --- Start New Test Logic (FIXED) ---
    window.startNewTest = () => {
        if (!currentTestId) return;
        console.log(`Navigating to test page for: ${currentTestId}`);
        // This will navigate to a page like 'physics_part1_test.html'
        // You will need to create this test page!
        window.location.href = `${currentTestId}_test.html`;
        closeModal();
    };

    // --- NEW: Bookmark Logic (Example) ---
    // You would call this from your actual test page, next to a question.
    // Example: <button onclick="toggleBookmark('physics_q123', 'What is the T2 signal...')">Bookmark</button>
    window.toggleBookmark = async (questionId, questionText) => {
        if (!currentUserId) {
            alert("You must be logged in to bookmark questions.");
            return;
        }

        const bookmarkRef = doc(db, "users", currentUserId, "bookmarks", questionId);

        try {
            const docSnap = await getDoc(bookmarkRef);
            if (docSnap.exists()) {
                // Bookmark exists, so we delete it (un-bookmark)
                await deleteDoc(bookmarkRef);
                alert("Bookmark removed!");
            } else {
                // Bookmark doesn't exist, so we create it
                await setDoc(bookmarkRef, {
                    question: questionText,
                    // You would add a link to the question here
                    // link: `/tests/physics_part1_test.html#${questionId}`,
                    timestamp: serverTimestamp()
                });
                alert("Question bookmarked!");
            }
        } catch (error) {
            console.error("Error toggling bookmark:", error);
            alert("There was an issue with your bookmark.");
        }
    };

  </script>
</body>
</html>
